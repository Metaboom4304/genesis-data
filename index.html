<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üß≠ GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      font-family: sans-serif;
    }

    #panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #111;
      color: #fff;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      padding: 8px 10px;
      gap: 10px;
      z-index: 1000;
      max-height: 300px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    #panel.collapsed {
      max-height: 40px;
    }

    #panel.collapsed > *:not(#map-title) {
      display: none;
    }

    #panel select,
    #panel input,
    #panel button {
      font-size: 14px;
      padding: 5px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }

    #panel label {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #search {
      width: 100px;
    }

    #search::placeholder {
      color: #888;
    }

    #toggle-panel {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: #111;
      color: #fff;
      border: none;
      padding: 8px;
      font-size: 18px;
      cursor: pointer;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .tile-label {
      font-size: 10px;
      font-weight: bold;
      color: #fff !important;
      background: none !important;
      padding: 0 !important;
      border: none !important;
      text-shadow: 0 0 3px #000;
    }

    .leaflet-interactive {
      stroke-width: 0.8 !important;
    }

    .leaflet-control-zoom {
      display: flex !important;
      flex-direction: row;
    }

    .leaflet-control-zoom .leaflet-bar-part {
      width: 30px;
    }

    @media (max-width: 600px) {
      #panel {
        flex-direction: column;
        align-items: flex-start;
      }
      #map {
        top: 180px;
      }
    }

    #map {
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
    }
  </style>
</head>
<body>
  <div id="panel">
    <strong id="map-title">üß≠ GENESIS WAR MAP</strong>

    <label for="search">
      üîç
      <input
        type="number"
        id="search"
        placeholder="–¢–∞–π–ª-ID"
        aria-label="–ü–æ–∏—Å–∫ –ø–æ ID —Ç–∞–π–ª–∞"
      />
      <button id="goto-btn" type="button" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–∞–π–ª—É">
        ‚û°Ô∏è
      </button>
    </label>

    <label for="status-filter">
      üéØ –ú–µ—Ç–∫–∞:
      <select id="status-filter" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Ç–∫–µ">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="ally">üü© –°–æ—é–∑–Ω–∏–∫–∏</option>
        <option value="enemy">üü• –í—Ä–∞–≥–∏</option>
        <option value="favorite">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</option>
        <option value="clear">‚ö™ –ë–µ–∑ –º–µ—Ç–∫–∏</option>
      </select>
    </label>

    <label for="layer-select">
      üó∫Ô∏è –°–ª–æ–π:
      <select id="layer-select" aria-label="–í—ã–±–æ—Ä —Å–ª–æ—è –∫–∞—Ä—Ç—ã">
        <option value="neutral">Neutral</option>
        <option value="world">–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</option>
        <option value="satellite">–°–ø—É—Ç–Ω–∏–∫</option>
      </select>
    </label>

    <button id="reset" type="button">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="export" type="button">üíæ CSV</button>
    <button id="screenshot-btn" type="button">üì∏ –°–Ω–∏–º–æ–∫</button>
    <span id="count">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–æ–≤‚Ä¶</span>
  </div>

  <div id="map" role="region" aria-label="–ö–∞—Ä—Ç–∞ GENESIS WAR MAP"></div>
  <button id="toggle-panel" type="button" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å">
    üîº
  </button>

  <script
    src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    defer
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
    defer
  ></script>
  <script defer>
    (() => {
      // 1. –°–ª—É—á–∞–π–Ω—ã–π —Å–ª–æ–≥–∞–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
      const phrases = [
        '–ö–∞–∂–¥—ã–π —Ö–æ–¥ –≤–∞–∂–µ–Ω',
        '–ú–æ—â—å –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö',
        '–ü–æ–±–µ–¥–∞ –∑–∞ –≥—Ä–∞–Ω—å—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞',
        '–¢–≤–æ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ',
        '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—É',
        '–ö–æ–º–∞–Ω–¥—É–π —Å –≤—ã—Å–æ—Ç—ã',
        '–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤ –∫–∞–∂–¥–æ–º –ø–∏–∫—Å–µ–ª–µ',
        '–í–æ–µ–≤–∞—Ç—å ‚Äî –∑–Ω–∞—á–∏—Ç –≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç—É',
        '–¢–∞–π–ª—ã ‚Äî –∫–ª—é—á –∫ –≤–ª–∞—Å—Ç–∏',
        '–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º',
        '–í–ª–∞—Å—Ç—å —á–µ—Ä–µ–∑ –∑–Ω–∞–Ω–∏–µ',
        '–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø–∏—à—É—Ç –∏—Å—Ç–æ—Ä–∏—é',
        '–ù–∞—à–∞ –∑–µ–º–ª—è ‚Äî –Ω–∞—à–µ –±–æ–≥–∞—Ç—Å—Ç–≤–æ',
        '–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–æ–∂–¥–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ',
      ];
      const titleEl = document.getElementById('map-title');
      titleEl.textContent = `üß≠ GENESIS WAR MAP ‚Äî ${
        phrases[Math.floor(Math.random() * phrases.length)]
      }`;

      // 2. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
      const panel = document.getElementById('panel');
      const toggle = document.getElementById('toggle-panel');
      toggle.addEventListener('click', () => {
        const collapsed = panel.classList.toggle('collapsed');
        toggle.textContent = collapsed ? 'üîΩ' : 'üîº';
      });

      // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ —Å–ª–æ—ë–≤
      const map = L.map('map', {
        center: [49.25, -123.1],
        zoom: 6,
        minZoom: 3,
        maxZoom: 10,
        attributionControl: false,
      });
      const layers = {
        neutral: L.tileLayer(
          'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
        ),
        world: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png'),
        satellite: L.tileLayer(
          'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          { attribution: 'Esri' }
        ),
      };
      layers.neutral.addTo(map);
      map.zoomControl.setPosition('bottomleft');

      document
        .getElementById('layer-select')
        .addEventListener('change', ({ target }) => {
          Object.values(layers).forEach((l) => map.removeLayer(l));
          layers[target.value].addTo(map);
        });

      // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–π–ª–æ–≤
      const BASE = './data/';
      const countEl = document.getElementById('count');
      let tileData = [];

      (async () => {
        try {
          for (let i = 1; i <= 22; i++) {
            countEl.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${i}/22‚Ä¶`;
            const resp = await fetch(
              `${BASE}tiles_${String(i).padStart(2, '0')}.json`
            );
            if (!resp.ok)
              throw new Error(`–û—à–∏–±–∫–∞ ${resp.status} –ø—Ä–∏ ${resp.url}`);
            tileData.push(...(await resp.json()));
          }
          countEl.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∞–π–ª–æ–≤: ${tileData.length}`;
        } catch (err) {
          console.error(err);
          alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}`);
        }

        // 5. –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        const refId = 22313;
        const refLat = 49.25;
        const refLng = -123.1;
        const refX = refId % 256;
        const refY = Math.floor(refId / 256);
        const degLat = 170 / 256;
        const degLng = 360 / 256;

        tileData.forEach((t) => {
          const id = Number(t.id_tile);
          const x = id % 256;
          const y = Math.floor(id / 256);
          t.lat = refLat - (y - refY) * degLat;
          t.lng = refLng + (x - refX) * degLng;
        });

        initializeDrawing();
      })();

      // 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–∫
      const saved = JSON.parse(
        localStorage.getItem('tile_marks') || '{}'
      );
      window.saveMark = (id, status) => {
        if (status) saved[id] = status;
        else delete saved[id];
        localStorage.setItem('tile_marks', JSON.stringify(saved));
        drawGrid();
        drawTiles();
      };

      // 7. –°–ª–æ—ë–≤—ã–µ –≥—Ä—É–ø–ø—ã
      const gridLayer = L.layerGroup().addTo(map);
      const tileLayer = L.layerGroup().addTo(map);

      // 8. –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
      function drawGrid() {
        gridLayer.clearLayers();
        const bounds = map.getBounds();

        tileData.forEach((t) => {
          if (!bounds.contains([t.lat, t.lng])) return;
          const rectBounds = L.latLngBounds(
            [t.lat - degLat / 2, t.lng - degLng / 2],
            [t.lat + degLat / 2, t.lng + degLng / 2]
          );
          L.rectangle(rectBounds, {
            stroke: true,
            weight: 0.8,
            color: '#666',
            fill: false,
          }).addTo(gridLayer);
        });
      }

      function drawTiles() {
        tileLayer.clearLayers();

        const filter = document.getElementById('status-filter').value;
        const searchVal = document.getElementById('search').value.trim();
        const byID = searchVal !== '';
        const zoom = map.getZoom();
        const bounds = map.getBounds();

        tileData.forEach((t) => {
          const status = saved[t.id_tile] || '';
          if (
            (filter === 'ally' && status !== 'ally') ||
            (filter === 'enemy' && status !== 'enemy') ||
            (filter === 'favorite' && status !== 'favorite') ||
            (filter === 'clear' && status)
          ) {
            return;
          }

          if (byID) {
            if (Number(t.id_tile) !== Number(searchVal)) return;
          } else if (!bounds.contains([t.lat, t.lng])) {
            return;
          }

          const rectBounds = L.latLngBounds(
            [t.lat - degLat / 2, t.lng - degLng / 2],
            [t.lat + degLat / 2, t.lng + degLng / 2]
          );

          const owned = String(t.has_owner).toLowerCase() === 'true';
          const fill = status === 'ally'
            ? '#33cc33'
            : status === 'enemy'
            ? '#cc3333'
            : status === 'favorite'
            ? '#ff0'
            : owned
            ? '#3366ff'
            : '#444';

          const stroke = status === 'ally'
            ? '#00ff00'
            : status === 'enemy'
            ? '#ff0000'
            : status === 'favorite'
            ? '#ff0'
            : '#000';

          const rect = L.rectangle(rectBounds, {
            stroke: true,
            weight: 1.2,
            color: stroke,
            dashArray: status ? '4' : null,
            fillColor: fill,
            fillOpacity: 0.4,
          }).addTo(tileLayer);

          if (zoom >= 5) {
            rect.bindTooltip(String(t.id_tile), {
              permanent: true,
              direction: 'center',
              className: 'tile-label',
            });
          }

          rect.bindPopup(`
            <strong>–¢–∞–π–ª #${t.id_tile}</strong><br/>
            –°—Ç–∞—Ç—É—Å: ${owned ? '–∑–∞–Ω—è—Ç' : '—Å–≤–æ–±–æ–¥–µ–Ω'}<br/>
            –ú–µ—Ç–∫–∞: ${status || '‚Äî'}<br/><br/>
            <button onclick="saveMark(${t.id_tile}, 'ally')">üü© –°–æ—é–∑–Ω–∏–∫</button>
            <button onclick="saveMark(${t.id_tile}, 'enemy')">üü• –í—Ä–∞–≥</button>
            <button onclick="saveMark(${t.id_tile}, 'favorite')">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button onclick="saveMark(${t.id_tile}, '')">‚ö™ –°–±—Ä–æ—Å–∏—Ç—å</button><br/><br/>
            <a
              href="https://genesis-of-ages.site/ru/–≥–µ–æ-—ç–∫—Å–ø–ª–æ—Ä–µ—Ä/?tileId=${t.id_tile}"
              target="_blank"
              rel="noopener"
            >üåê –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a>
          `);

          rect.on('click', () => {
            rect.setStyle({ weight: 3, color: '#FFD700' });
            rect.openPopup();
          });
          rect.on('mouseout', () =>
            rect.setStyle({ weight: 1.2, color: stroke })
          );
        });
      }

      // 9. –ü–æ–∏—Å–∫ –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
      document.getElementById('goto-btn').addEventListener('click', () => {
        const val = document.getElementById('search').value.trim();
        if (!val) return drawTiles();

        const tile = tileData.find((o) => +o.id_tile === +val);
        if (!tile) return;

        map.flyTo([tile.lat, tile.lng], 6, {
          animate: true,
          duration: 1.2,
        });
        setTimeout(drawTiles, 800);
      });

      // 10. –≠–∫—Å–ø–æ—Ä—Ç, —Å–±—Ä–æ—Å, —Å–∫—Ä–∏–Ω—à–æ—Ç
      document.getElementById('reset').addEventListener('click', () => {
        document.getElementById('search').value = '';
        document.getElementById('status-filter').value = '';
        drawGrid();
        drawTiles();
      });

      document.getElementById('export').addEventListener('click', () => {
        const rows = [['id_tile', 'has_owner', 'status']];
        tileData.forEach((t) => {
          const status = saved[t.id_tile] || '';
          rows.push([t.id_tile, t.has_owner, status]);
        });
        const csv = rows.map((r) => r.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'tiles.csv';
        a.click();
      });

      document
        .getElementById('screenshot-btn')
        .addEventListener('click', () => {
          html2canvas(document.getElementById('map')).then((canvas) => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'map.png';
            link.click();
          });
        });

      // 11. –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–∞—Ä—Ç—ã –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      map.on('moveend', () => {
        drawGrid();
        drawTiles();
      });

      ['change', 'input'].forEach((ev) => {
        document
          .getElementById('status-filter')
          .addEventListener(ev, drawTiles);
        document.getElementById('search').addEventListener(ev, drawTiles);
      });

      // 12. –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä + –≤–µ—Ä—Å–∏—è
      const initializeDrawing = () => {
        drawGrid();
        drawTiles();
        document.body.insertAdjacentHTML(
          'beforeend',
          `<div style="
            position:fixed;
            bottom:6px;
            left:10px;
            font-size:12px;
            font-family:monospace;
            color:#888;
            z-index:999;
            pointer-events:none;
          ">ver 0.13</div>`
        );
      };
    })();
  </script>
</body>
</html>
