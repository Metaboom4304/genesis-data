<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- MapLibre вместо Mapbox -->
  <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet' />
  
  <!-- Иконки для интерфейса -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      background: #0d1117;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      color: #fff;
    }
    
    /* Загрузочный экран */
    .loader-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.9)), url('./1755546482.png') center/cover no-repeat;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }
    
    .loader-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .loader-text {
      font-size: 1.2rem;
      margin-bottom: 20px;
      text-align: center;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 25px;
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }
    
    .progress-container {
      background: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }
    
    .progress-bar {
      width: 300px;
      height: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4dabf7, #3bc9db);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 1rem;
      color: #aaa;
      text-align: center;
    }
    
    /* Основной контейнер */
    .app-container {
      display: flex;
      height: 100vh;
    }
    
    /* Боковая панель */
    .sidebar {
      width: 350px;
      background: rgba(20, 20, 30, 0.95);
      border-right: 1px solid #2c3e50;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: width 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    .sidebar.collapsed {
      width: 60px;
    }
    
    .sidebar-header {
      padding: 15px;
      background: rgba(30, 30, 40, 0.95);
      border-bottom: 1px solid #2c3e50;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .sidebar-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: #74c0fc;
      white-space: nowrap;
      overflow: hidden;
    }
    
    .toggle-sidebar {
      background: none;
      border: none;
      color: #74c0fc;
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    /* Поиск и фильтры */
    .search-section {
      padding: 15px;
      border-bottom: 1px solid #2c3e50;
    }
    
    .search-box {
      display: flex;
      margin-bottom: 15px;
    }
    
    .search-input {
      flex: 1;
      padding: 10px 15px;
      background: rgba(40, 40, 50, 0.8);
      border: 1px solid #495057;
      border-radius: 4px 0 0 4px;
      color: #e9ecef;
      font-size: 1rem;
    }
    
    .search-button {
      padding: 10px 15px;
      background: #4dabf7;
      border: none;
      border-radius: 0 4px 4px 0;
      color: white;
      cursor: pointer;
    }
    
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .filter-btn {
      padding: 8px 12px;
      background: rgba(50, 50, 60, 0.8);
      border: 1px solid #495057;
      border-radius: 4px;
      color: #e9ecef;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: #4dabf7;
      color: white;
      border-color: #4dabf7;
    }
    
    /* Список избранного */
    .favorites-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .section-header {
      padding: 12px 15px;
      background: rgba(30, 30, 40, 0.95);
      border-bottom: 1px solid #2c3e50;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    
    .section-title {
      font-size: 1rem;
      color: #ffd43b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    
    .favorites-list {
      list-style: none;
    }
    
    .favorite-item {
      padding: 10px;
      background: rgba(50, 50, 60, 0.6);
      margin-bottom: 8px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    
    .favorite-item:hover {
      background: rgba(50, 50, 60, 0.8);
    }
    
    .favorite-actions {
      display: flex;
      gap: 5px;
    }
    
    .action-btn {
      padding: 5px 8px;
      background: #495057;
      border: none;
      border-radius: 3px;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .action-btn:hover {
      background: #5c636a;
    }
    
    /* Карта */
    .map-container {
      flex: 1;
      position: relative;
    }
    
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }
    
    /* Панель управления картой */
    .map-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 900;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .control-btn {
      width: 40px;
      height: 40px;
      background: rgba(30, 30, 40, 0.95);
      border: 1px solid #495057;
      border-radius: 50%;
      color: #e9ecef;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(5px);
    }
    
    .control-btn:hover {
      background: rgba(50, 50, 60, 0.95);
      transform: translateY(-2px);
    }
    
    /* Стили для маркеров */
    .tile-marker {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s;
    }
    
    .tile-marker:hover {
      transform: scale(1.1);
    }
    
    .tile-label {
      font-size: 10px;
      color: white;
      text-shadow: 0 0 2px black;
      font-weight: bold;
    }
    
    /* Всплывающее окно */
    .mapboxgl-popup-content {
      background: rgba(30, 30, 40, 0.95);
      color: white;
      padding: 15px;
      border-radius: 8px;
      min-width: 280px;
      backdrop-filter: blur(5px);
    }
    
    .mapboxgl-popup-close-button {
      color: white;
      font-size: 18px;
    }
    
    .popup-header {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #495057;
    }
    
    .popup-title {
      font-size: 1.2rem;
      color: #74c0fc;
      margin-bottom: 5px;
    }
    
    .popup-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-label {
      font-size: 0.8rem;
      color: #adb5bd;
    }
    
    .info-value {
      font-size: 0.9rem;
      color: white;
    }
    
    .popup-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .action-button {
      padding: 8px;
      background: #495057;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: background 0.2s;
    }
    
    .action-button:hover {
      background: #5c636a;
    }
    
    .action-button.ally {
      background: #2b8a3e;
    }
    
    .action-button.ally:hover {
      background: #2f9e44;
    }
    
    .action-button.enemy {
      background: #c92a2a;
    }
    
    .action-button.enemy:hover {
      background: #e03131;
    }
    
    .action-button.favorite {
      background: #e67700;
    }
    
    .action-button.favorite:hover {
      background: #f59f00;
    }
    
    .comment-section {
      margin-top: 15px;
    }
    
    .comment-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      background: #343a40;
      color: white;
      border: 1px solid #495057;
      border-radius: 4px;
      resize: vertical;
      margin-bottom: 10px;
    }
    
    .save-button {
      width: 100%;
      padding: 10px;
      background: #3b5bdb;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .save-button:hover {
      background: #364fc7;
    }
    
    /* Адаптивность */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        max-height: 40vh;
      }
      
      .sidebar.collapsed {
        width: 100%;
        height: 50px;
      }
      
      .sidebar-header {
        padding: 10px;
      }
      
      .search-section {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Загрузочный экран -->
  <div class="loader-screen" id="loader-screen">
    <div class="loader-text" id="loader-text">Подготовка к возрождению цивилизации...</div>
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">0%</div>
    </div>
  </div>

  <div class="app-container">
    <!-- Боковая панель -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">GENESIS WAR MAP</div>
        <button class="toggle-sidebar" id="toggle-sidebar">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      
      <div class="search-section">
        <div class="search-box">
          <input type="text" class="search-input" id="search-input" placeholder="Введите ID тайла..." />
          <button class="search-button" id="search-button">
            <i class="fas fa-search"></i>
          </button>
        </div>
        
        <div class="filter-grid">
          <button class="filter-btn" data-filter="all">
            <i class="fas fa-layer-group"></i> Все
          </button>
          <button class="filter-btn" data-filter="ally">
            <i class="fas fa-handshake"></i> Союзники
          </button>
          <button class="filter-btn" data-filter="enemy">
            <i class="fas fa-skull-crossbones"></i> Враги
          </button>
          <button class="filter-btn" data-filter="favorite">
            <i class="fas fa-star"></i> Избранное
          </button>
        </div>
      </div>
      
      <div class="favorites-section">
        <div class="section-header" id="favorites-header">
          <div class="section-title">
            <i class="fas fa-star"></i> Избранные тайлы
          </div>
          <i class="fas fa-chevron-down"></i>
        </div>
        
        <div class="section-content">
          <ul class="favorites-list" id="favorites-list">
            <!-- Список избранного будет заполнен динамически -->
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Контейнер карты -->
    <div class="map-container">
      <div id="map"></div>
      
      <!-- Панель управления картой -->
      <div class="map-controls">
        <button class="control-btn" id="zoom-in" title="Приблизить">
          <i class="fas fa-plus"></i>
        </button>
        <button class="control-btn" id="zoom-out" title="Отдалить">
          <i class="fas fa-minus"></i>
        </button>
        <button class="control-btn" id="reset-view" title="Сбросить вид">
          <i class="fas fa-globe"></i>
        </button>
        <button class="control-btn" id="screenshot" title="Сделать скриншот">
          <i class="fas fa-camera"></i>
        </button>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    // Конфигурация
    const API_URL = 'https://genesis-map-api.onrender.com';
    const degLat = 170/256, degLng = 360/256;
    const CACHE_TTL = 15 * 60 * 1000; // 15 минут
    
    // Глобальные переменные
    let map;
    let tileData = [];
    let tileMarkers = {};
    let currentUser = null;
    let userMarks = {};
    let favorites = [];
    let currentFilter = 'all';
    
    // Элементы UI
    const loaderScreen = document.getElementById('loader-screen');
    const loaderText = document.getElementById('loader-text');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    // Инициализация приложения
    async function initApp() {
      try {
        updateProgress(10, 'Инициализация приложения...');
        
        // Инициализация Telegram WebApp
        const user = initTelegram();
        
        // Инициализация интерфейса
        initUI();
        
        // Инициализация карты
        await initMap();
        
        updateProgress(30, 'Загрузка данных...');
        
        // Загрузка данных
        await loadData();
        
        updateProgress(70, 'Отрисовка карты...');
        
        // Отрисовка тайлов
        drawTiles();
        renderFavorites();
        
        updateProgress(100, 'Готово!');
        
        // Скрываем загрузочный экран
        setTimeout(() => {
          if (loaderScreen) {
            loaderScreen.classList.add('fade-out');
          }
        }, 500);
        
      } catch (error) {
        console.error('Ошибка инициализации:', error);
        alert('Произошла критическая ошибка при запуске приложения');
      }
    }
    
    // Инициализация Telegram WebApp
    function initTelegram() {
      const tg = window.Telegram?.WebApp;
      
      if (tg) {
        tg.ready();
        tg.expand();
        return tg.initDataUnsafe?.user || null;
      }
      
      // Тестовый пользователь для разработки
      return { 
        id: 'test-user', 
        first_name: 'Тестовый пользователь',
        last_name: 'Тестовый',
        username: 'testuser'
      };
    }
    
    // Инициализация интерфейса
    function initUI() {
      // Переключение боковой панели
      document.getElementById('toggle-sidebar').addEventListener('click', function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        this.innerHTML = sidebar.classList.contains('collapsed') ? 
          '<i class="fas fa-chevron-right"></i>' : 
          '<i class="fas fa-chevron-left"></i>';
      });
      
      // Поиск тайлов
      document.getElementById('search-button').addEventListener('click', searchTile);
      document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchTile();
      });
      
      // Фильтры
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          currentFilter = this.dataset.filter;
          drawTiles();
        });
      });
      
      // Управление картой
      document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
      document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
      document.getElementById('reset-view').addEventListener('click', resetView);
      document.getElementById('screenshot').addEventListener('click', takeScreenshot);
      
      // Избранное
      document.getElementById('favorites-header').addEventListener('click', function() {
        const content = this.nextElementSibling;
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
        this.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');
      });
    }
    
    // Инициализация карты
    async function initMap() {
      // Создаем карту с использованием MapLibre
      map = new maplibregl.Map({
        container: 'map',
        style: 'https://demotiles.maplibre.org/style.json',
        center: [-123.10, 49.25], // [lng, lat]
        zoom: 6,
        minZoom: 3,
        maxZoom: 10,
        attributionControl: false
      });
      
      // Добавляем элементы управления
      map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
      
      // Обработчики событий карты
      map.on('load', () => {
        console.log('Карта успешно загружена');
      });
      
      map.on('moveend', () => {
        drawTiles();
      });
      
      map.on('zoomend', () => {
        drawTiles();
      });
      
      return new Promise((resolve) => {
        map.on('load', resolve);
      });
    }
    
    // Загрузка данных
    async function loadData() {
      try {
        // Регистрация пользователя в API
        try {
          await fetch(`${API_URL}/api/users/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              telegram_id: currentUser.id,
              first_name: currentUser.first_name,
              last_name: currentUser.last_name,
              username: currentUser.username
            })
          });
        } catch (error) {
          console.error('Ошибка регистрации пользователя:', error);
        }
        
        // Загрузка пользовательских меток
        const userResponse = await fetch(`${API_URL}/api/marks/${currentUser.id}`);
        if (!userResponse.ok) throw new Error(`Ошибка загрузки меток: ${userResponse.status}`);
        
        const marks = await userResponse.json();
        userMarks = {};
        marks.forEach(mark => {
          if (!userMarks[mark.tile_id]) userMarks[mark.tile_id] = {};
          userMarks[mark.tile_id][mark.mark_type] = mark.comment || true;
          
          if (mark.mark_type === 'favorite') {
            favorites.push(mark.tile_id);
          }
        });
        
        // Загрузка кеша тайлов
        let cacheValid = false;
        try {
          const cacheResponse = await fetch(`${API_URL}/api/tiles-cache`);
          if (cacheResponse.ok) {
            const cache = await cacheResponse.json();
            const cacheAge = Date.now() - new Date(cache.last_updated).getTime();
            if (cacheAge < CACHE_TTL) {
              tileData = Array.isArray(cache.data.tiles) ? cache.data.tiles : Object.values(cache.data.tiles || {});
              cacheValid = true;
            }
          }
        } catch (error) {
          console.error('Ошибка загрузки кеша:', error);
        }
        
        // Если кеш устарел или отсутствует
        if (!cacheValid) {
          const tileResponse = await fetch(`${API_URL}/api/proxy/tile-info`);
          if (!tileResponse.ok) throw new Error(`Ошибка загрузки тайлов: ${tileResponse.status}`);
          
          const tilesResponse = await tileResponse.json();
          tileData = Array.isArray(tilesResponse.tiles) ? tilesResponse.tiles : Object.values(tilesResponse.tiles || {});
          
          // Сохраняем в кеш
          try {
            await fetch(`${API_URL}/api/tiles-cache`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ tilesResponse })
            });
          } catch (error) {
            console.error('Ошибка сохранения кеша:', error);
          }
        }
        
        // Инициализация координат
        initTileCoordinates();
        
      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        throw error;
      }
    }
    
    // Инициализация координат тайлов
    function initTileCoordinates() {
      const refId = 22313, refLat = 49.25, refLng = -123.10;
      const refX = refId % 256, refY = Math.floor(refId/256);
      
      tileData.forEach(t => {
        if (!t || t.id_tile == null) return;
        
        const x = parseInt(t.id_tile) % 256;
        const y = Math.floor(parseInt(t.id_tile)/256);
        t.lng = refLng + (x - refX) * degLng; // lng first для MapLibre
        t.lat = refLat - (y - refY) * degLat;
      });
    }
    
    // Отрисовка тайлов
    function drawTiles() {
      // Очищаем предыдущие маркеры
      Object.values(tileMarkers).forEach(marker => marker.remove());
      tileMarkers = {};
      
      const searchValue = document.getElementById('search-input').value.trim();
      const bounds = map.getBounds();
      
      tileData.forEach(t => {
        // Пропускаем тайлы без координат
        if (!t || t.lat === undefined || t.lng === undefined) return;
        
        // Фильтрация
        const tileMarks = userMarks[t.id_tile] || {};
        const status = 
          tileMarks.ally ? 'ally' :
          tileMarks.enemy ? 'enemy' :
          tileMarks.favorite ? 'favorite' : '';
        
        // Применяем фильтры
        if (currentFilter === 'ally' && !tileMarks.ally) return;
        if (currentFilter === 'enemy' && !tileMarks.enemy) return;
        if (currentFilter === 'favorite' && !tileMarks.favorite) return;
        if (searchValue && String(t.id_tile) !== searchValue) return;
        if (!bounds.contains([t.lng, t.lat])) return;
        
        // Создаем маркер
        tileMarkers[t.id_tile] = createTileMarker(t, tileMarks);
      });
    }
    
    // Создание маркера для тайла
    function createTileMarker(t, marks) {
      const status = 
        marks.ally ? 'ally' :
        marks.enemy ? 'enemy' :
        marks.favorite ? 'favorite' : '';
      
      const comment = marks.comment || '';
      const owned = t.has_owner === 'true' || t.has_owner === true;
      
      // Стилизация
      const fill = status === 'ally' ? '#40c057' :
                  status === 'enemy' ? '#fa5252' :
                  status === 'favorite' ? '#fab005' :
                  owned ? '#4dabf7' : '#495057';
                  
      const stroke = status === 'ally' ? '#2f9e44' :
                    status === 'enemy' ? '#e03131' :
                    status === 'favorite' ? '#f59f00' : '#343a40';
      
      const element = document.createElement('div');
      element.className = 'tile-marker';
      element.style.backgroundColor = fill;
      element.style.border = `2px solid ${stroke}`;
      
      // Добавление подписи
      if (map.getZoom() >= 5) {
        const label = document.createElement('div');
        label.className = 'tile-label';
        label.textContent = `#${t.id_tile}`;
        element.appendChild(label);
      }
      
      // Создаем маркер
      const marker = new maplibregl.Marker({ element })
        .setLngLat([t.lng, t.lat])
        .addTo(map);
      
      // Добавляем всплывающее окно
      marker.setPopup(createTilePopup(t, marks));
      
      return marker;
    }
    
    // Создание всплывающего окна для тайла
    function createTilePopup(t, marks) {
      const status = 
        marks.ally ? 'ally' :
        marks.enemy ? 'enemy' :
        marks.favorite ? 'favorite' : '';
      
      const comment = marks.comment || '';
      const owned = t.has_owner === 'true' || t.has_owner === true;
      
      const popupContent = document.createElement('div');
      
      popupContent.innerHTML = `
        <div class="popup-header">
          <div class="popup-title">Тайл #${t.id_tile}</div>
        </div>
        
        <div class="popup-info">
          <div class="info-item">
            <span class="info-label">Статус:</span>
            <span class="info-value">${owned ? 'Занят' : 'Свободен'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Метка:</span>
            <span class="info-value">${status || '—'}</span>
          </div>
        </div>
        
        <div class="popup-actions">
          <button class="action-button ally" data-id="${t.id_tile}" data-type="ally">
            <i class="fas fa-handshake"></i> Союзник
          </button>
          <button class="action-button enemy" data-id="${t.id_tile}" data-type="enemy">
            <i class="fas fa-skull-crossbones"></i> Враг
          </button>
          <button class="action-button favorite" data-id="${t.id_tile}" data-type="favorite">
            <i class="fas fa-star"></i> В избранное
          </button>
          <button class="action-button" data-id="${t.id_tile}" data-type="clear">
            <i class="fas fa-times"></i> Сбросить
          </button>
        </div>
        
        <div class="comment-section">
          <textarea class="comment-textarea" id="comment-${t.id_tile}" placeholder="Ваш комментарий...">${comment}</textarea>
          <button class="save-button" data-id="${t.id_tile}">
            <i class="fas fa-save"></i> Сохранить комментарий
          </button>
        </div>
      `;
      
      const popup = new maplibregl.Popup({ offset: 25 })
        .setDOMContent(popupContent);
      
      // Добавляем обработчики событий после создания попапа
      setTimeout(() => {
        const popupElement = popup.getElement();
        if (popupElement) {
          popupElement.addEventListener('click', (e) => {
            if (e.target.classList.contains('action-button') || 
                e.target.parentElement.classList.contains('action-button')) {
              
              const button = e.target.classList.contains('action-button') ? 
                e.target : e.target.parentElement;
              
              const tileId = button.dataset.id;
              const markType = button.dataset.type;
              saveMark(tileId, markType);
            }
            
            if (e.target.classList.contains('save-button') || 
                e.target.parentElement.classList.contains('save-button')) {
              
              const button = e.target.classList.contains('save-button') ? 
                e.target : e.target.parentElement;
              
              const tileId = button.dataset.id;
              const comment = document.getElementById(`comment-${tileId}`).value;
              saveMark(tileId, 'comment', comment);
            }
          });
        }
      }, 100);
      
      return popup;
    }
    
    // Поиск тайла
    function searchTile() {
      const tileId = document.getElementById('search-input').value.trim();
      if (!tileId) return;
      
      const tile = tileData.find(t => t.id_tile == tileId);
      if (!tile) {
        alert(`Тайл #${tileId} не найден`);
        return;
      }
      
      // Центрируем карту на найденном тайле
      map.flyTo({
        center: [tile.lng, tile.lat],
        zoom: 7,
        essential: true
      });
    }
    
    // Сброс вида карты
    function resetView() {
      map.flyTo({
        center: [-123.10, 49.25],
        zoom: 6,
        essential: true
      });
      
      // Сброс фильтров
      document.getElementById('search-input').value = '';
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === 'all') btn.classList.add('active');
      });
      
      currentFilter = 'all';
      drawTiles();
    }
    
    // Скриншот карты
    function takeScreenshot() {
      html2canvas(document.getElementById('map')).then(canvas => {
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `genesis-war-map-${new Date().toISOString().slice(0, 19)}.png`;
        link.click();
      });
    }
    
    // Сохранение метки
    async function saveMark(tileId, markType, comment = null) {
      try {
        const response = await fetch(`${API_URL}/api/marks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUser.id,
            tile_id: tileId,
            mark_type: markType,
            comment: comment
          })
        });
        
        if (!response.ok) throw new Error(`Ошибка сохранения: ${response.status}`);
        
        // Обновление локального состояния
        if (!userMarks[tileId]) userMarks[tileId] = {};
        
        if (markType === 'clear') {
          delete userMarks[tileId];
          favorites = favorites.filter(favId => favId !== tileId);
        } else {
          userMarks[tileId][markType] = comment || true;
          if (markType === 'favorite' && !favorites.includes(tileId)) {
            favorites.push(tileId);
          }
        }
        
        // Обновление UI
        drawTiles();
        renderFavorites();
        
      } catch (error) {
        console.error('Ошибка сохранения метки:', error);
        alert('Ошибка сохранения метки');
      }
    }
    
    // Отрисовка избранного
    function renderFavorites() {
      const favList = document.getElementById('favorites-list');
      if (!favList) return;
      
      favList.innerHTML = favorites.map(id => {
        const tile = tileData.find(t => t.id_tile === id);
        return `
          <li class="favorite-item">
            <span>Тайл #${id}</span>
            <div class="favorite-actions">
              <button class="action-btn goto-fav" data-id="${id}" title="Перейти">
                <i class="fas fa-location-arrow"></i>
              </button>
              <button class="action-btn remove-fav" data-id="${id}" title="Удалить">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </li>
        `;
      }).join('');
      
      // Добавляем обработчики событий для избранного
      favList.querySelectorAll('.goto-fav').forEach(btn => {
        btn.addEventListener('click', () => {
          const tileId = btn.dataset.id;
          const tile = tileData.find(t => t.id_tile === tileId);
          if (tile) {
            map.flyTo({
              center: [tile.lng, tile.lat],
              zoom: 7,
              essential: true
            });
          }
        });
      });
      
      favList.querySelectorAll('.remove-fav').forEach(btn => {
        btn.addEventListener('click', () => {
          const tileId = btn.dataset.id;
          saveMark(tileId, 'clear');
        });
      });
    }
    
    // Обновление прогресса загрузки
    function updateProgress(percent, message = '') {
      if (progressFill) {
        progressFill.style.width = `${percent}%`;
      }
      if (progressText) {
        progressText.textContent = `${Math.round(percent)}%`;
      }
      if (message && loaderText) {
        loaderText.textContent = message;
      }
    }
    
    // Запуск приложения
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
