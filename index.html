<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- MapLibre вместо Mapbox -->
  <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet' />
  
  <!-- Иконки для интерфейса -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    /* Ваши стили остаются без изменений */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* ... остальные стили ... */
  </style>
</head>
<body>
  <!-- Загрузочный экран -->
  <div class="loader-screen" id="loader-screen">
    <div class="loader-text" id="loader-text">Инициализация карты древних цивилизаций...</div>
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">0%</div>
    </div>
  </div>

  <div class="app-container">
    <!-- Боковая панель -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">GENESIS WAR MAP</div>
        <button class="toggle-sidebar" id="toggle-sidebar">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      
      <div class="search-section">
        <div class="search-box">
          <input type="text" class="search-input" id="search-input" placeholder="Введите ID тайла..." />
          <button class="search-button" id="search-button">
            <i class="fas fa-search"></i>
          </button>
        </div>
        
        <div class="filter-grid">
          <button class="filter-btn active" data-filter="all">
            <i class="fas fa-layer-group"></i> Все
          </button>
          <button class="filter-btn" data-filter="ally">
            <i class="fas fa-handshake"></i> Союзники
          </button>
          <button class="filter-btn" data-filter="enemy">
            <i class="fas fa-skull-crossbones"></i> Враги
          </button>
          <button class="filter-btn" data-filter="favorite">
            <i class="fas fa-star"></i> Избранное
          </button>
        </div>
      </div>
      
      <div class="favorites-section">
        <div class="section-header" id="favorites-header">
          <div class="section-title">
            <i class="fas fa-star"></i> Избранные тайлы
          </div>
          <i class="fas fa-chevron-down"></i>
        </div>
        
        <div class="section-content">
          <ul class="favorites-list" id="favorites-list">
            <!-- Список избранного будет заполнен динамически -->
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Контейнер карты -->
    <div class="map-container" id="map-container">
      <div id="map"></div>
      
      <!-- Кнопка разворачивания панели -->
      <button class="expand-panel-btn" id="expand-panel-btn">
        <i class="fas fa-chevron-right"></i>
      </button>
      
      <!-- Компас -->
      <div class="compass" id="compass">
        <i class="fas fa-compass"></i>
      </div>
      
      <!-- Панель слоев -->
      <div class="layers-panel" id="layers-panel">
        <button class="layer-btn active" data-layer="standard">
          <i class="fas fa-map"></i> Стандартная
        </button>
        <button class="layer-btn" data-layer="satellite">
          <i class="fas fa-satellite"></i> Спутник
        </button>
        <button class="layer-btn" data-layer="dark">
          <i class="fas fa-moon"></i> Тёмная
        </button>
      </div>
      
      <!-- Панель управления картой -->
      <div class="map-controls">
        <button class="control-btn" id="zoom-in" title="Приблизить">
          <i class="fas fa-plus"></i>
        </button>
        <button class="control-btn" id="zoom-out" title="Отдалить">
          <i class="fas fa-minus"></i>
        </button>
        <button class="control-btn" id="reset-view" title="Сбросить вид">
          <i class="fas fa-globe"></i>
        </button>
        <button class="control-btn" id="screenshot" title="Сделать скриншот">
          <i class="fas fa-camera"></i>
        </button>
        <button class="control-btn" id="layers-toggle" title="Слои карты">
          <i class="fas fa-layer-group"></i>
        </button>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    // Конфигурация - ИСПРАВЛЕННЫЕ URL
    const API_URL = 'https://genesis-data.onrender.com';
    const BOT_API_URL = 'https://genesis-war-bot.onrender.com';
    const CACHE_TTL = 15 * 60 * 1000; // 15 минут
    
    // Глобальные переменные
    let map;
    let tileData = [];
    let tileMarkers = {};
    let currentUser = null;
    let userMarks = {};
    let favorites = [];
    let currentFilter = 'all';
    let loadingMessages = [
      "Инициализация карты древних цивилизаций...",
      "Загрузка данных о тайлах...",
      "Анализ ресурсов территории...",
      "Сканирование вражеских позиций...",
      "Построение стратегических маршрутов...",
      "Обновление карты союзников...",
      "Калибровка навигационных систем...",
      "Загрузка тактических данных...",
      "Инициализация системы меток...",
      "Оптимизация производительности...",
      "Подготовка к возрождению цивилизации...",
      "Синхронизация с серверами Genesis...",
      "Загрузка информации о ресурсах...",
      "Анализ климатических условий...",
      "Построение карты высот..."
    ];
    let currentMessageIndex = 0;
    let messageInterval;
    
    // Элементы UI
    const loaderScreen = document.getElementById('loader-screen');
    const loaderText = document.getElementById('loader-text');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    // Инициализация приложения
    async function initApp() {
      try {
        startLoadingMessages();
        updateProgress(10, loadingMessages[0]);
        
        // Инициализация Telegram WebApp
        currentUser = await initTelegram();
        console.log('Текущий пользователь:', currentUser);
        
        // Проверяем доступность серверов
        await checkServers();
        
        // Инициализация интерфейса
        initUI();
        
        // Инициализация карты
        await initMap();
        
        updateProgress(30, "Загрузка данных...");
        
        // Загрузка данных
        await loadData();
        
        updateProgress(70, "Отрисовка карты...");
        
        // Отрисовка тайлов
        drawTiles();
        renderFavorites();
        
        updateProgress(100, "Готово!");
        
        // Скрываем загрузочный экран
        setTimeout(() => {
          if (loaderScreen) {
            loaderScreen.classList.add('fade-out');
            clearInterval(messageInterval);
          }
        }, 500);
        
      } catch (error) {
        console.error('Ошибка инициализации:', error);
        if (loaderText) {
          loaderText.textContent = "Ошибка инициализации. Пожалуйста, обновите страницу.";
        }
      }
    }
    
    // Проверка доступности серверов
    async function checkServers() {
      try {
        console.log('Проверка доступности серверов...');
        
        // Проверка API сервера
        try {
          const apiCheck = await fetch(`${API_URL}/health`, { 
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          console.log('API сервер доступен:', apiCheck.ok);
          if (!apiCheck.ok) {
            console.error('API сервер недоступен');
          }
        } catch (apiError) {
          console.error('Ошибка подключения к API серверу:', apiError);
        }
        
        // Проверка бота
        try {
          const botCheck = await fetch(`${BOT_API_URL}/health`, { 
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          console.log('Бот сервер доступен:', botCheck.ok);
          if (!botCheck.ok) {
            console.error('Бот сервер недоступен');
          }
        } catch (botError) {
          console.error('Ошибка подключения к бот серверу:', botError);
        }
      } catch (error) {
        console.error('Проверка серверов не удалась:', error);
      }
    }
    
    // Запуск меняющихся сообщений загрузки
    function startLoadingMessages() {
      messageInterval = setInterval(() => {
        currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
        if (loaderText) {
          loaderText.textContent = loadingMessages[currentMessageIndex];
        }
      }, 5000);
    }
    
    // Инициализация Telegram WebApp
    async function initTelegram() {
      try {
        // Проверяем, доступен ли Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
          const tg = window.Telegram.WebApp;
          tg.ready();
          tg.expand();
          
          // Извлекаем данные пользователя из initData
          if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            console.log('Пользователь из Telegram:', user);
            
            // Регистрируем пользователя в боте
            await registerUserInBot(user);
            
            return user;
          }
          
          // Пытаемся извлечь данные из URL параметров
          const urlParams = new URLSearchParams(window.location.hash.substring(1));
          const tgWebAppData = urlParams.get('tgWebAppData');
          
          if (tgWebAppData) {
            const params = new URLSearchParams(tgWebAppData);
            const userParam = params.get('user');
            
            if (userParam) {
              try {
                const user = JSON.parse(decodeURIComponent(userParam));
                console.log('Пользователь из URL параметров:', user);
                
                // Регистрируем пользователя в боте
                await registerUserInBot(user);
                
                return user;
              } catch (e) {
                console.error('Ошибка парсинга пользовательских данных:', e);
              }
            }
          }
        }
        
        // Если не удалось получить данные из Telegram, используем тестового пользователя
        console.warn('Telegram WebApp не предоставил данные пользователя, используется тестовый аккаунт');
        return getTestUser();
      } catch (error) {
        console.error('Ошибка инициализации Telegram WebApp:', error);
        return getTestUser();
      }
    }
    
    // Регистрация пользователя в боте - ИСПРАВЛЕННАЯ ВЕРСИЯ
    async function registerUserInBot(user) {
      try {
        const response = await fetch(`${BOT_API_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegram_id: user.id,
            first_name: user.first_name,
            last_name: user.last_name || '',
            username: user.username,
            language_code: user.language_code || 'ru'
          })
        });
        
        if (response.ok) {
          console.log('Пользователь успешно зарегистрирован в боте');
          const data = await response.json();
          console.log('Ответ от бота:', data);
        } else {
          console.error('Ошибка регистрации в боте:', response.status, await response.text());
        }
      } catch (error) {
        console.error('Ошибка при регистрации в боте:', error);
      }
    }
    
    // Создание тестового пользователя
    function getTestUser() {
      return { 
        id: 766057421, 
        first_name: 'Stanislav',
        last_name: '',
        username: 'Stansilav93',
        language_code: 'ru',
        is_premium: true
      };
    }
    
    // Инициализация интерфейса
    function initUI() {
      // Переключение боковой панели
      document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
      document.getElementById('expand-panel-btn').addEventListener('click', toggleSidebar);
      
      // Поиск тайлов
      document.getElementById('search-button').addEventListener('click', searchTile);
      document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchTile();
      });
      
      // Фильтры
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          currentFilter = this.dataset.filter;
          drawTiles();
        });
      });
      
      // Управление картой
      document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
      document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
      document.getElementById('reset-view').addEventListener('click', resetView);
      document.getElementById('screenshot').addEventListener('click', takeScreenshot);
      document.getElementById('layers-toggle').addEventListener('click', toggleLayersPanel);
      
      // Слои карты
      document.querySelectorAll('.layer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          changeMapStyle(this.dataset.layer);
        });
      });
      
      // Избранное
      document.getElementById('favorites-header').addEventListener('click', function() {
        const content = this.nextElementSibling;
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
        this.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');
      });
      
      // Компас - сброс вращения карты
      document.getElementById('compass').addEventListener('click', function() {
        map.resetNorthPitch();
      });
    }
    
    // Переключение боковой панели
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const expandBtn = document.getElementById('expand-panel-btn');
      const mapContainer = document.getElementById('map-container');
      
      sidebar.classList.toggle('collapsed');
      
      if (sidebar.classList.contains('collapsed')) {
        expandBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        mapContainer.style.marginLeft = '0';
      } else {
        expandBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        mapContainer.style.marginLeft = '0';
      }
      
      // Обновляем размер карты
      setTimeout(() => {
        if (map) {
          map.resize();
          drawTiles();
        }
      }, 300);
    }
    
    // Переключение панели слоев
    function toggleLayersPanel() {
      const layersPanel = document.getElementById('layers-panel');
      layersPanel.style.display = layersPanel.style.display === 'none' ? 'flex' : 'none';
    }
    
    // Инициализация карты
    async function initMap() {
      // Создаем карту с использованием MapLibre
      map = new maplibregl.Map({
        container: 'map',
        style: getMapStyle('standard'),
        center: [-123.10, 49.25], // [lng, lat]
        zoom: 6,
        minZoom: 3,
        maxZoom: 10,
        attributionControl: false
      });
      
      // Добавляем элементы управления
      map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
      
      // Обновляем компас при вращении карты
      map.on('rotate', () => {
        updateCompassRotation();
      });
      
      // Обработчики событий карты
      map.on('load', () => {
        console.log('Карта успешно загружена');
      });
      
      map.on('moveend', () => {
        drawTiles();
      });
      
      map.on('zoomend', () => {
        drawTiles();
      });
      
      map.on('resize', () => {
        drawTiles();
      });
      
      return new Promise((resolve) => {
        map.on('load', resolve);
      });
    }
    
    // Получение стиля карты
    function getMapStyle(styleName) {
      const styles = {
        standard: 'https://demotiles.maplibre.org/style.json',
        satellite: 'https://api.maptiler.com/maps/hybrid/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL',
        dark: 'https://api.maptiler.com/maps/dark-matter/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL'
      };
      
      return styles[styleName] || styles.standard;
    }
    
    // Изменение стиля карты
    function changeMapStyle(styleName) {
      map.setStyle(getMapStyle(styleName));
    }
    
    // Обновление вращения компаса
    function updateCompassRotation() {
      const compass = document.getElementById('compass');
      const rotation = map.getBearing() * -1; // Инвертируем вращение
      compass.style.transform = `rotate(${rotation}deg)`;
    }
    
    // Загрузка данных - ИСПРАВЛЕННАЯ ВЕРСИЯ
    async function loadData() {
      try {
        // Регистрация пользователя в API
        try {
          const response = await fetch(`${API_URL}/api/users/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              telegram_id: currentUser.id,
              first_name: currentUser.first_name,
              last_name: currentUser.last_name || '',
              username: currentUser.username,
              language_code: currentUser.language_code || 'ru',
              is_premium: currentUser.is_premium || false
            })
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Ошибка регистрации пользователя:', response.status, errorText);
          } else {
            console.log('Пользователь успешно зарегистрирован в API');
          }
        } catch (error) {
          console.error('Ошибка регистрации пользователя:', error);
        }
        
        // Загрузка пользовательских меток
        const userResponse = await fetch(`${API_URL}/api/marks/${currentUser.id}`);
        if (!userResponse.ok) {
          console.error('Ошибка загрузки меток:', userResponse.status, await userResponse.text());
          throw new Error(`Ошибка загрузки меток: ${userResponse.status}`);
        }
        
        const marks = await userResponse.json();
        userMarks = {};
        marks.forEach(mark => {
          if (!userMarks[mark.tile_id]) userMarks[mark.tile_id] = {};
          userMarks[mark.tile_id][mark.mark_type] = mark.comment || true;
          
          if (mark.mark_type === 'favorite') {
            favorites.push(mark.tile_id);
          }
        });
        
        // Загрузка кеша тайлов
        let cacheValid = false;
        try {
          const cacheResponse = await fetch(`${API_URL}/api/tiles-cache`);
          if (cacheResponse.ok) {
            const cache = await cacheResponse.json();
            const cacheAge = Date.now() - new Date(cache.last_updated).getTime();
            if (cacheAge < CACHE_TTL) {
              tileData = Array.isArray(cache.data.tiles) ? cache.data.tiles : Object.values(cache.data.tiles || {});
              cacheValid = true;
            }
          }
        } catch (error) {
          console.error('Ошибка загрузки кеша:', error);
        }
        
        // Если кеш устарел или отсутствует
        if (!cacheValid) {
          const tileResponse = await fetch(`${API_URL}/api/proxy/tile-info`);
          if (!tileResponse.ok) {
            console.error('Ошибка загрузки тайлов:', tileResponse.status, await tileResponse.text());
            throw new Error(`Ошибка загрузки тайлов: ${tileResponse.status}`);
          }
          
          const tilesResponse = await tileResponse.json();
          tileData = Array.isArray(tilesResponse.tiles) ? tilesResponse.tiles : Object.values(tilesResponse.tiles || {});
          
          // Сохраняем в кеш
          try {
            await fetch(`${API_URL}/api/tiles-cache`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ tilesResponse })
            });
          } catch (error) {
            console.error('Ошибка сохранения кеша:', error);
          }
        }
        
        // Инициализация координат
        initTileCoordinates();
        
      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        if (loaderText) {
          loaderText.textContent = "Ошибка загрузки данных. Пожалуйста, обновите страницу.";
        }
        throw error;
      }
    }
    
    // Инициализация координат тайлов (ПЕРЕСЧИТАННАЯ ВЕРСИЯ)
    function initTileCoordinates() {
      // Правильная формула расчета координат на основе предоставленных данных
      tileData.forEach(t => {
        if (!t || t.id_tile == null) return;
        
        const tileId = parseInt(t.id_tile);
        
        // Размеры тайла в градусах (на основе официальных данных)
        const tileWidth = 1.40625;  // градусов долготы
        const tileHeight = 0.915483; // градусов широты
        
        // Опорный тайл 22313 (Ванкувер)
        const refId = 22313;
        const refX = refId % 256;
        const refY = Math.floor(refId / 256);
        const refLng = -123.046875; // Центр тайла 22313
        const refLat = 49.3802405;  // Центр тайла 22313
        
        // Координаты текущего тайла
        const x = tileId % 256;
        const y = Math.floor(tileId / 256);
        
        // Расчет координат (правильная формула)
        t.lng = refLng + (x - refX) * tileWidth;
        t.lat = refLat - (y - refY) * tileHeight;
        
        // Обеспечиваем валидность координат
        t.lng = Math.max(-180, Math.min(180, t.lng));
        t.lat = Math.max(-90, Math.min(90, t.lat));
        
        console.log(`Тайл ${t.id_tile}: lat=${t.lat}, lng=${t.lng}`);
      });
    }
    
    // Отрисовка тайлов
    function drawTiles() {
      // Очищаем предыдущие маркеры
      Object.values(tileMarkers).forEach(marker => marker.remove());
      tileMarkers = {};
      
      const searchValue = document.getElementById('search-input').value.trim();
      const bounds = map.getBounds();
      
      tileData.forEach(t => {
        // Пропускаем тайлы без координат
        if (!t || t.lat === undefined || t.lng === undefined) return;
        
        // Фильтрация
        const tileMarks = userMarks[t.id_tile] || {};
        const status = 
          tileMarks.ally ? 'ally' :
          tileMarks.enemy ? 'enemy' :
          tileMarks.favorite ? 'favorite' : '';
        
        // Применяем фильтры
        if (currentFilter === 'ally' && !tileMarks.ally) return;
        if (currentFilter === 'enemy' && !tileMarks.enemy) return;
        if (currentFilter === 'favorite' && !tileMarks.favorite) return;
        if (searchValue && String(t.id_tile) !== searchValue) return;
        if (!bounds.contains([t.lng, t.lat])) return;
        
        // Создаем маркер
        tileMarkers[t.id_tile] = createTileMarker(t, tileMarks);
      });
    }
    
    // Создание маркера для тайла
    function createTileMarker(t, marks) {
      const status = 
        marks.ally ? 'ally' :
        marks.enemy ? 'enemy' :
        marks.favorite ? 'favorite' : '';
      
      const comment = marks.comment || '';
      const owned = t.has_owner === 'true' || t.has_owner === true;
      
      // Стилизация - улучшенная
      const fill = status === 'ally' ? '#40c057' :
                  status === 'enemy' ? '#fa5252' :
                  status === 'favorite' ? '#fab005' :
                  owned ? '#4dabf7' : 'rgba(73, 80, 87, 0.7)'; // Полупрозрачный для незанятых
                  
      const stroke = status === 'ally' ? '#2f9e44' :
                    status === 'enemy' ? '#e03131' :
                    status === 'favorite' ? '#f59f00' : 'rgba(255, 255, 255, 0.5)'; // Светлая обводка
      
      const element = document.createElement('div');
      element.className = 'tile-marker';
      element.style.backgroundColor = fill;
      element.style.border = `2px solid ${stroke}`;
      
      // Добавление подписи
      if (map.getZoom() >= 5) {
        const label = document.createElement('div');
        label.className = 'tile-label';
        label.textContent = `#${t.id_tile}`;
        element.appendChild(label);
      }
      
      // Создаем маркер
      const marker = new maplibregl.Marker({ element })
        .setLngLat([t.lng, t.lat])
        .addTo(map);
      
      // Добавляем всплывающее окно
      marker.setPopup(createTilePopup(t, marks));
      
      return marker;
    }
    
    // Создание всплывающего окна для тайла
    function createTilePopup(t, marks) {
      const status = 
        marks.ally ? 'ally' :
        marks.enemy ? 'enemy' :
        marks.favorite ? 'favorite' : '';
      
      const comment = marks.comment || '';
      const owned = t.has_owner === 'true' || t.has_owner === true;
      
      const popupContent = document.createElement('div');
      
      popupContent.innerHTML = `
        <div class="popup-header">
          <div class="popup-title">Тайл #${t.id_tile}</div>
        </div>
        
        <div class="popup-info">
          <div class="info-item">
            <span class="info-label">Статус:</span>
            <span class="info-value">${owned ? 'Занят' : 'Свободен'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Метка:</span>
            <span class="info-value">${status || '—'}</span>
          </div>
        </div>
        
        <div class="popup-actions">
          <button class="action-button ally" data-id="${t.id_tile}" data-type="ally">
            <i class="fas fa-handshake"></i> Союзник
          </button>
          <button class="action-button enemy" data-id="${t.id_tile}" data-type="enemy">
            <i class="fas fa-skull-crossbones"></i> Враг
          </button>
          <button class="action-button favorite" data-id="${t.id_tile}" data-type="favorite">
            <i class="fas fa-star"></i> В избранное
          </button>
          <button class="action-button" data-id="${t.id_tile}" data-type="clear">
            <i class="fas fa-times"></i> Сбросить
          </button>
        </div>
        
        <div class="comment-section">
          <textarea class="comment-textarea" id="comment-${t.id_tile}" placeholder="Ваш комментарий...">${comment}</textarea>
          <button class="save-button" data-id="${t.id_tile}">
            <i class="fas fa-save"></i> Сохранить комментарий
          </button>
        </div>
      `;
      
      const popup = new maplibregl.Popup({ offset: 25 })
        .setDOMContent(popupContent);
      
      // Добавляем обработчики событий после создания попапа
      setTimeout(() => {
        const popupElement = popup.getElement();
        if (popupElement) {
          popupElement.addEventListener('click', (e) => {
            if (e.target.classList.contains('action-button') || 
                e.target.parentElement.classList.contains('action-button')) {
              
              const button = e.target.classList.contains('action-button') ? 
                e.target : e.target.parentElement;
              
              const tileId = button.dataset.id;
              const markType = button.dataset.type;
              saveMark(tileId, markType);
            }
            
            if (e.target.classList.contains('save-button') || 
                e.target.parentElement.classList.contains('save-button')) {
              
              const button = e.target.classList.contains('save-button') ? 
                e.target : e.target.parentElement;
              
              const tileId = button.dataset.id;
              const comment = document.getElementById(`comment-${tileId}`).value;
              saveMark(tileId, 'comment', comment);
            }
          });
        }
      }, 100);
      
      return popup;
    }
    
    // Поиск тайла
    function searchTile() {
      const tileId = document.getElementById('search-input').value.trim();
      if (!tileId) return;
      
      const tile = tileData.find(t => t.id_tile == tileId);
      if (!tile) {
        alert(`Тайл #${tileId} не найден`);
        return;
      }
      
      // Центрируем карту на найденном тайле
      map.flyTo({
        center: [tile.lng, tile.lat],
        zoom: 7,
        essential: true
      });
    }
    
    // Сброс вида карты
    function resetView() {
      map.flyTo({
        center: [-123.10, 49.25],
        zoom: 6,
        essential: true
      });
      
      // Сброс фильтров
      document.getElementById('search-input').value = '';
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === 'all') btn.classList.add('active');
      });
      
      currentFilter = 'all';
      drawTiles();
    }
    
    // Скриншот карты
    function takeScreenshot() {
      // Показываем уведомление о начале создания скриншота
      const notification = document.createElement('div');
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.left = '50%';
      notification.style.transform = 'translateX(-50%)';
      notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      notification.style.color = 'white';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '5px';
      notification.style.zIndex = '1000';
      notification.textContent = 'Создание скриншота...';
      document.body.appendChild(notification);
      
      // Скрываем элементы управления для скриншота
      const controls = document.querySelectorAll('.map-controls, .compass, .layers-panel, .expand-panel-btn');
      controls.forEach(control => {
        control.style.visibility = 'hidden';
      });
      
      // Даем время на скрытие элементов
      setTimeout(() => {
        html2canvas(document.getElementById('map')).then(canvas => {
          // Восстанавливаем элементы управления
          controls.forEach(control => {
            control.style.visibility = 'visible';
          });
          
          // Удаляем уведомление
          document.body.removeChild(notification);
          
          // Создаем и скачиваем скриншот
          const link = document.createElement('a');
          link.href = canvas.toDataURL('image/png');
          link.download = `genesis-war-map-${new Date().toISOString().slice(0, 19)}.png`;
          link.click();
        }).catch(error => {
          console.error('Ошибка создания скриншота:', error);
          // Восстанавливаем элементы управления в случае ошибки
          controls.forEach(control => {
            control.style.visibility = 'visible';
          });
          document.body.removeChild(notification);
          alert('Ошибка создания скриншота');
        });
      }, 100);
    }
    
    // Сохранение метки - ИСПРАВЛЕННАЯ ВЕРСИЯ
    async function saveMark(tileId, markType, comment = null) {
      try {
        const payload = {
          user_id: currentUser.id,
          tile_id: tileId,
          mark_type: markType
        };
        
        if (comment !== null) {
          payload.comment = comment;
        }
        
        const response = await fetch(`${API_URL}/api/marks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Ошибка сохранения: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log('Метка успешно сохранена:', result);
        
        // Обновление локального состояния
        if (!userMarks[tileId]) userMarks[tileId] = {};
        
        if (markType === 'clear') {
          delete userMarks[tileId];
          favorites = favorites.filter(favId => favId != tileId);
        } else {
          userMarks[tileId][markType] = comment || true;
          if (markType === 'favorite' && !favorites.includes(tileId)) {
            favorites.push(tileId);
          }
        }
        
        // Обновление UI
        drawTiles();
        renderFavorites();
        
        // Отправляем уведомление в бот
        try {
          await fetch(`${BOT_API_URL}/notify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: currentUser.id,
              tile_id: tileId,
              action: markType,
              comment: comment
            })
          });
        } catch (botError) {
          console.error('Ошибка отправки уведомления в бот:', botError);
        }
        
      } catch (error) {
        console.error('Ошибка сохранения метки:', error);
        alert('Ошибка сохранения метки: ' + error.message);
      }
    }
    
    // Отрисовка избранного
    function renderFavorites() {
      const favList = document.getElementById('favorites-list');
      if (!favList) return;
      
      favList.innerHTML = favorites.map(id => {
        const tile = tileData.find(t => t.id_tile === id);
        return `
          <li class="favorite-item">
            <span>Тайл #${id}</span>
            <div class="favorite-actions">
              <button class="action-btn goto-fav" data-id="${id}" title="Перейти">
                <i class="fas fa-location-arrow"></i>
              </button>
              <button class="action-btn remove-fav" data-id="${id}" title="Удалить">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </li>
        `;
      }).join('');
      
      // Добавляем обработчики событий для избранного
      favList.querySelectorAll('.goto-fav').forEach(btn => {
        btn.addEventListener('click', () => {
          const tileId = btn.dataset.id;
          const tile = tileData.find(t => t.id_tile === tileId);
          if (tile) {
            map.flyTo({
              center: [tile.lng, tile.lat],
              zoom: 7,
              essential: true
            });
          }
        });
      });
      
      favList.querySelectorAll('.remove-fav').forEach(btn => {
        btn.addEventListener('click', () => {
          const tileId = btn.dataset.id;
          saveMark(tileId, 'clear');
        });
      });
    }
    
    // Обновление прогресса загрузки
    function updateProgress(percent, message = '') {
      if (progressFill) {
        progressFill.style.width = `${percent}%`;
      }
      if (progressText) {
        progressText.textContent = `${Math.round(percent)}%`;
      }
      if (message && loaderText) {
        loaderText.textContent = message;
      }
    }
    
    // Запуск приложения
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
