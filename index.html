<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { position: absolute; top: 60px; left: 0; right: 0; bottom: 0; }
    #panel {
      position: absolute; top: 0; left: 0; right: 0;
      background: #111; color: white;
      display: flex; flex-wrap: wrap;
      align-items: center; padding: 8px 10px;
      gap: 10px; z-index: 1000;
    }
    #panel select, #panel input, #panel button {
      font-size: 14px; padding: 5px;
    }
    #panel label { display: flex; align-items: center; gap: 5px; }
    .tile-label {
      font-size: 10px;
      color: rgba(255,255,255,0.8);
      text-shadow: 0 0 2px black;
    }
    @media (max-width: 600px) {
      #panel { flex-direction: column; align-items: flex-start; }
      #map { top: 220px; }
    }
  </style>
</head>
<body>
  <div id="panel">
    <strong>üß≠ GENESIS WAR MAP:</strong> –ó–¥–µ—Å—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ç–≤–æ–µ–≥–æ –≥–æ—Å–ø–æ–¥—Å—Ç–≤–∞.
    <label>üîç ID: <input type="number" id="search" placeholder="22313" /></label>
    <label>‚öôÔ∏è –†–µ—Å—É—Ä—Å: 
      <select id="filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="iron">–ñ–µ–ª–µ–∑–æ</option>
        <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
        <option value="platinum">–ü–ª–∞—Ç–∏–Ω–∞</option>
        <option value="silver">–°–µ—Ä–µ–±—Ä–æ</option>
        <option value="copper">–ú–µ–¥—å</option>
        <option value="tungsten">–í–æ–ª—å—Ñ—Ä–∞–º</option>
        <option value="uranium">–£—Ä–∞–Ω</option>
        <option value="rare_earth_elements">–†–µ–¥–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã</option>
      </select>
    </label>
    <label>üéØ –°—Ç–∞—Ç—É—Å:
      <select id="mark-mode">
        <option value="">‚Äî –†–µ–∂–∏–º ‚Äî</option>
        <option value="ally">üü© –°–æ—é–∑–Ω–∏–∫</option>
        <option value="enemy">üü• –í—Ä–∞–≥</option>
        <option value="clear">‚ö™ –°–±—Ä–æ—Å–∏—Ç—å</option>
      </select>
    </label>
    <label>üó∫Ô∏è –°–ª–æ–π:
      <select id="layer-select">
        <option value="osm">OpenStreetMap</option>
        <option value="carto">Carto Dark</option>
      </select>
    </label>
    <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="export">üíæ –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <span id="count">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–æ–≤‚Ä¶</span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    (async function(){
  const layers = {
    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }),
    carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '¬© CartoDB'
    })
  };

  const map = L.map('map', {
    center: [0, 0],
    zoom: 2,
    minZoom: 2,
    maxZoom: 8,
    layers: [layers.osm]
  });

  const tileLayer = L.layerGroup().addTo(map);

  document.getElementById('layer-select').addEventListener('change', e => {
    const selected = e.target.value;
    Object.values(layers).forEach(l => map.removeLayer(l));
    layers[selected].addTo(map);
  });

  let tileData = [];
  try {
    const res = await fetch('./data/data-genesis.json');
    tileData = await res.json();
    document.getElementById("count").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∞–π–ª–æ–≤: ${tileData.length}`;
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:", err);
    return;
  }

  const savedMarks = JSON.parse(localStorage.getItem('tile_marks') || '{}');
  function saveMark(id, status) {
    if (status) savedMarks[id] = status;
    else delete savedMarks[id];
    localStorage.setItem('tile_marks', JSON.stringify(savedMarks));
  }

  function drawTiles() {
    tileLayer.clearLayers();
    const resourceFilter = document.getElementById('filter').value;
    const searchID = parseInt(document.getElementById('search').value);

    tileData.forEach(t => {
      if (!t.lat || !t.lng) return;
      if (resourceFilter && parseInt(t[resourceFilter]) === 0) return;
      if (!isNaN(searchID) && parseInt(t.id_tile) !== searchID) return;

      const lat = parseFloat(t.lat);
      const lng = parseFloat(t.lng);
      const bounds = L.latLngBounds([lat - 0.5, lng - 0.5], [lat + 0.5, lng + 0.5]);

      const owned = String(t.has_owner).toLowerCase() === "true";
      const status = savedMarks[t.id_tile];

      const color = status === "ally" ? "#33cc33" :
                    status === "enemy" ? "#cc3333" :
                    owned ? "#3366ff" : "#444444";

      const resources = [
        'iron','gold','platinum','silver','copper',
        'tungsten','uranium','rare_earth_elements'
      ].filter(r => parseInt(t[r]) > 0)
       .map(r => `‚Ä¢ ${r}: ${t[r]}`)
       .join('<br>');

      L.rectangle(bounds, {
        weight: 1,
        color: status === "ally" ? "#00ff00" :
               status === "enemy" ? "#ff0000" : "#000000",
        fillOpacity: 0.4,
        fillColor: color
      })
      .bindPopup(`
        <strong>–¢–∞–π–ª #${t.id_tile}</strong><br>
        –í–ª–∞–¥–µ–ª–µ—Ü: ${owned ? '‚úÖ' : '‚Äî'}<br>
        –°—Ç–∞—Ç—É—Å: ${status || '‚Äî'}<br>
        ${resources || '–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤'}
      `)
      .on('click', () => {
        const mode = document.getElementById('mark-mode').value;
        saveMark(t.id_tile, mode === 'clear' ? null : mode);
        drawTiles();
      })
      .addTo(tileLayer);
    });
  }

  document.getElementById('reset').addEventListener('click', () => {
    document.getElementById('search').value = '';
    document.getElementById('filter').value = '';
    document.getElementById('mark-mode').value = '';
    drawTiles();
  });

  document.getElementById('export').addEventListener('click', () => {
    const rows = [["id_tile","has_owner","status","resources"]];
    tileData.forEach(t => {
      const status = savedMarks[t.id_tile] || '';
      const resources = [
        'iron','gold','platinum','silver','copper',
        'tungsten','uranium','rare_earth_elements'
      ].filter(r => parseInt(t[r]) > 0).join(",");
      rows.push([t.id_tile, t.has_owner, status, resources]);
    });
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "genesis_tiles.csv";
    a.click();
  });

  document.getElementById('filter').addEventListener('change', drawTiles);
  document.getElementById('search').addEventListener('input', drawTiles);
  document.getElementById('mark-mode').addEventListener('change', () => drawTiles());

  function focusTile(idStr) {
    const id = parseInt(idStr);
    const tile = tileData.find(t => parseInt(t.id_tile) === id);
    if (!tile || !tile.lat || !tile.lng) return;
    const lat = parseFloat(tile.lat);
    const lng = parseFloat(tile.lng);
    map.flyTo([lat, lng], 6);
    setTimeout(() => {
      L.popup().setLatLng([lat, lng]).setContent(`üß≠ –¢–∞–π–ª #${id}`).openOn(map);
    }, 800);
  }

  document.getElementById('search').addEventListener('change', (e) => {
    focusTile(e.target.value);
  });

  drawTiles();
})();
    </script>
</body>
</html>
