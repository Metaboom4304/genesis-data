<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <style>
    html, body {
      margin:0; padding:0; height:100%; background:#000;
      font-family:sans-serif;
    }
    #map {
      position:absolute; top:60px; left:0; right:0; bottom:0;
    }
    #panel {
      position:absolute; top:0; left:0; right:0;
      background:#111; color:#fff;
      display:flex; flex-wrap:wrap; align-items:center;
      padding:8px 10px; gap:10px;
      z-index:1000; max-height:300px; overflow:hidden;
      transition:max-height .3s ease;
    }
    #panel.collapsed { max-height:40px; }
    #panel.collapsed > *:not(#map-title) { display:none; }
    #panel select, #panel input, #panel button {
      font-size:14px; padding:5px;
      background:#222; color:#fff; border:1px solid #444;
    }
    #panel label { display:flex; align-items:center; gap:5px; }
    #search { width:100px; }
    #search::placeholder { color:#888; }
    #toggle-panel {
      position:absolute; bottom:15px; right:15px;
      background:#111; color:#fff; border:none;
      padding:8px; font-size:18px; cursor:pointer;
      z-index:1000; transition:transform .3s ease;
    }
    .tile-label {
      font-size:10px; font-weight:bold;
      color:#fff!important;
      background:none!important;
      padding:0!important; border:none!important;
      text-shadow:0 0 3px #000;
    }
    .leaflet-interactive { stroke-width:0.8!important; }
    .leaflet-control-zoom {
      display:flex!important; flex-direction:row;
    }
    .leaflet-control-zoom .leaflet-bar-part {
      width:30px;
    }
    @media(max-width:600px){
      #panel { flex-direction:column; align-items:flex-start; }
      #map   { top:180px; }
    }
  </style>
</head>
<body>

  <div id="panel">
    <strong id="map-title">üß≠ GENESIS WAR MAP</strong>

    <label>
      üîç<input type="number" id="search" placeholder="–¢–∞–π–ª-ID"/>
      <button id="goto-btn">‚û°Ô∏è</button>
    </label>

    <label>
      üéØ –ú–µ—Ç–∫–∞:
      <select id="status-filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="ally">üü© –°–æ—é–∑–Ω–∏–∫–∏</option>
        <option value="enemy">üü• –í—Ä–∞–≥–∏</option>
        <option value="favorite">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</option>
        <option value="clear">‚ö™ –ë–µ–∑ –º–µ—Ç–∫–∏</option>
      </select>
    </label>

    <label>
      üó∫Ô∏è –°–ª–æ–π:
      <select id="layer-select">
        <option value="neutral">Neutral</option>
        <option value="world">–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</option>
        <option value="satellite">–°–ø—É—Ç–Ω–∏–∫</option>
      </select>
    </label>

    <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="export">üíæ CSV</button>
    <button id="screenshot-btn">üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
    <span id="count">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–æ–≤‚Ä¶</span>
  </div>

  <div id="map"></div>
  <button id="toggle-panel">üîº</button>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
;(async function(){
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  const phrases = [
    '–ö–∞–∂–¥—ã–π —Ö–æ–¥ –≤–∞–∂–µ–Ω','–ú–æ—â—å –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö','–ü–æ–±–µ–¥–∞ –∑–∞ –≥—Ä–∞–Ω—å—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞',
    '–¢–≤–æ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ','–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—É','–ö–æ–º–∞–Ω–¥—É–π —Å –≤—ã—Å–æ—Ç—ã',
    '–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤ –∫–∞–∂–¥–æ–º –ø–∏–∫—Å–µ–ª–µ','–í–æ–µ–≤–∞—Ç—å ‚Äî –∑–Ω–∞—á–∏—Ç –≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç—É',
    '–¢–∞–π–ª—ã ‚Äî –∫–ª—é—á –∫ –≤–ª–∞—Å—Ç–∏','–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º',
    '–í–ª–∞—Å—Ç—å —á–µ—Ä–µ–∑ –∑–Ω–∞–Ω–∏–µ','–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø–∏—à—É—Ç –∏—Å—Ç–æ—Ä–∏—é',
    '–ù–∞—à–∞ –∑–µ–º–ª—è ‚Äî –Ω–∞—à–µ –±–æ–≥–∞—Ç—Å—Ç–≤–æ','–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–æ–∂–¥–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ'
  ];
  document.getElementById('map-title').textContent =
    `üß≠ GENESIS WAR MAP ‚Äî ${phrases[Math.floor(Math.random()*phrases.length)]}`;

  // Toggle –ø–∞–Ω–µ–ª–∏
  const panel = document.getElementById('panel'),
        toggle = document.getElementById('toggle-panel');
  toggle.onclick = ()=> {
    const c = panel.classList.toggle('collapsed');
    toggle.textContent = c?'üîΩ':'üîº';
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (zoom=6)
  const map = L.map('map',{
    center:[49.25,-123.10], zoom:6, minZoom:3, maxZoom:10,
    attributionControl:false
  });
  const layers = {
    neutral: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
    world:   L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png'),
    satellite: L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Esri' })
  };
  layers.neutral.addTo(map);
  map.zoomControl.setPosition('bottomleft');
  document.getElementById('layer-select').onchange = e => {
    Object.values(layers).forEach(l=>map.removeLayer(l));
    layers[e.target.value].addTo(map);
  };

  // –°–ª–æ–∏ —Å–µ—Ç–∫–∏ –∏ —Ç–∞–π–ª–æ–≤
  const gridLayer = L.layerGroup().addTo(map),
        tileLayer = L.layerGroup().addTo(map);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  const BASE = './data/', countEl = document.getElementById('count');
  let tileData = [];
  try {
    for(let i=1; i<=22; i++){
      countEl.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${i}/22‚Ä¶`;
      const url=`${BASE}tiles_${String(i).padStart(2,'0')}.json`,
            res=await fetch(url);
      if(!res.ok) throw new Error(`–û—à–∏–±–∫–∞ ${res.status} –ø—Ä–∏ ${url}`);
      tileData.push(...await res.json());
    }
  } catch(e) {
    console.error(e);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message);
  }
  countEl.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∞–π–ª–æ–≤: ${tileData.length}`;

  // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  const refId=22313, refLat=49.25, refLng=-123.10,
        refX=refId%256, refY=Math.floor(refId/256),
        degLat=170/256, degLng=360/256;
  tileData.forEach(t=>{
    const id=+t.id_tile, x=id%256, y=Math.floor(id/256);
    t.lat = refLat - (y - refY)*degLat;
    t.lng = refLng + (x - refX)*degLng;
  });

  // LocalStorage –¥–ª—è –º–µ—Ç–æ–∫ + –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
  const saved = JSON.parse(localStorage.getItem('tile_marks')||'{}');
  window.saveMark = (id,status)=>{
    if(status) saved[id]=status;
    else delete saved[id];
    localStorage.setItem('tile_marks', JSON.stringify(saved));
    drawGrid(); drawTiles();
  };

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
  function drawGrid(){
    gridLayer.clearLayers();
    const vb=map.getBounds();
    tileData.forEach(t=>{
      if(!vb.contains([t.lat,t.lng])) return;
      const b=L.latLngBounds(
        [t.lat-degLat/2, t.lng-degLng/2],
        [t.lat+degLat/2, t.lng+degLng/2]
      );
      L.rectangle(b,{stroke:true,weight:0.8,color:'#666',fill:false})
       .addTo(gridLayer);
    });
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–π–ª–æ–≤
  function drawTiles(){
    tileLayer.clearLayers();
    const stF=document.getElementById('status-filter').value,
          sRaw=document.getElementById('search').value.trim(),
          byID=sRaw!=='', ID=+sRaw, zoom=map.getZoom(),
          vb=map.getBounds();
    tileData.forEach(t=>{
      const status=saved[t.id_tile]||'';
      if(stF==='ally'  && status!=='ally')  return;
      if(stF==='enemy' && status!=='enemy') return;
      if(stF==='favorite'&&status!=='favorite') return;
      if(stF==='clear' && status)           return;
      if(byID){
        if(+t.id_tile!==ID) return;
      } else {
        if(!vb.contains([t.lat,t.lng])) return;
      }
      const b=L.latLngBounds(
        [t.lat-degLat/2, t.lng-degLng/2],
        [t.lat+degLat/2, t.lng+degLng/2]
      );
      const owned = String(t.has_owner).toLowerCase()==='true';
      const fill = status==='ally'? '#33cc33'
                 : status==='enemy'? '#cc3333'
                 : status==='favorite'? '#ff0'
                 : owned? '#3366ff':'#444';
      const stroke = status==='ally'? '#00ff00'
                   : status==='enemy'? '#ff0000'
                   : status==='favorite'? '#ff0':'#000';
      const rect=L.rectangle(b,{
        stroke:true, weight:1.2, color:stroke,
        dashArray:status?'4':null, fillColor:fill, fillOpacity:0.4
      }).addTo(tileLayer);

      if(zoom>=5){
        rect.bindTooltip(String(t.id_tile),{
          permanent:true, direction:'center', className:'tile-label'
        });
      }

      rect.bindPopup(`
        <strong>–¢–∞–π–ª #${t.id_tile}</strong><br/>
        –°—Ç–∞—Ç—É—Å: ${owned?'–∑–∞–Ω—è—Ç':'—Å–≤–æ–±–æ–¥–µ–Ω'}<br/>
        –ú–µ—Ç–∫–∞: ${status||'‚Äî'}<br/><br/>
        <button class="mark-btn" onclick="saveMark(${t.id_tile},'ally')">üü© –°–æ—é–∑–Ω–∏–∫</button>
        <button class="mark-btn" onclick="saveMark(${t.id_tile},'enemy')">üü• –í—Ä–∞–≥</button>
        <button class="mark-btn" onclick="saveMark(${t.id_tile},'favorite')">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <button class="mark-btn" onclick="saveMark(${t.id_tile},'')">‚ö™ –°–±—Ä–æ—Å–∏—Ç—å</button><br/><br/>
        <a href="https://genesis-of-ages.site/ru/–≥–µ–æ-—ç–∫—Å–ø–ª–æ—Ä–µ—Ä/?tileId=${t.id_tile}"
           target="_blank">
          üåê –û—Ñ. —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–∞–π–ª–∞
        </a>
      `);

      rect.on('click', ()=>{
        rect.setStyle({weight:3,color:'#FFD700'});
        rect.openPopup();
      });
      rect.on('mouseout', ()=> rect.setStyle({weight:1.2,color:stroke}));
    });
  }

  // –ü–æ–∏—Å–∫ + flyTo
  document.getElementById('goto-btn').onclick = ()=>{
    const v=document.getElementById('search').value.trim();
    if(!v) return drawTiles();
    const t=tileData.find(o=>+o.id_tile===+v);
    if(!t) return;
    map.flyTo([t.lat,t.lng],6,{animate:true,duration:1.2});
    setTimeout(drawTiles,800);
  };

  // Reset –∏ —ç–∫—Å–ø–æ—Ä—Ç CSV
  document.getElementById('reset').onclick = ()=>{
    document.getElementById('search').value='';
    document.getElementById('status-filter').value='';
    drawGrid(); drawTiles();
  };
  document.getElementById('export').onclick = ()=>{
    const rows=[['id_tile','has_owner','status']];
    tileData.forEach(t=>{
      const st=saved[t.id_tile]||'';
      rows.push([t.id_tile, t.has_owner, st]);
    });
    const csv=rows.map(r=>r.join(',')).join('\n'),
          blob=new Blob([csv],{type:'text/csv'}),
          a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='tiles.csv';
    a.click();
  };

  // –°–∫—Ä–∏–Ω—à–æ—Ç
  document.getElementById('screenshot-btn').onclick = ()=>{
    html2canvas(document.getElementById('map')).then(canvas=>{
      const link=document.createElement('a');
      link.href=canvas.toDataURL('image/png');
      link.download='map.png';
      link.click();
    });
  };

  // –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–∞—Ä—Ç—ã –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  map.on('moveend', ()=>{ drawGrid(); drawTiles(); });
  ['change','input'].forEach(ev=>{
    document.getElementById('status-filter')
      .addEventListener(ev, drawTiles);
    document.getElementById('search')
      .addEventListener(ev, drawTiles);
  });

  // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä + –≤–µ—Ä—Å–∏—è
  drawGrid(); drawTiles();
  document.body.insertAdjacentHTML('beforeend', `
    <div style="
      position:fixed; bottom:6px; left:10px;
      font-size:12px; font-family:monospace;
      color:#888; z-index:999; pointer-events:none;
    ">
      ver 0.13
    </div>
  `);

})();
  </script>
  <script>
fetch('map-status.json')
  .then(r => r.json())
  .then(status => {
    const now = new Date();
    const until = new Date(status.disableUntil);
    const themes = {
      morning: { bg: "#ffe8b0", color: "#000", icon: "üåÖ", tagline: "Genesis –ø—Ä–æ—Å–Ω—ë—Ç—Å—è –ø–æ–∑–∂–µ" },
      day:     { bg: "#f0f0f0", color: "#222", icon: "üåû", tagline: "Genesis –Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ" },
      night:   { bg: "#0f0f0f", color: "#fff", icon: "üåô", tagline: "Genesis –æ—Ç–¥—ã—Ö–∞–µ—Ç" },
      holiday: { bg: "#ff4d4d", color: "#fff", icon: "üéâ", tagline: "Genesis –ø—Ä–∞–∑–¥–Ω—É–µ—Ç!" }
    };

    const autoTheme = (() => {
      const hour = now.getHours();
      if (hour >= 6 && hour < 12) return "morning";
      if (hour >= 12 && hour < 18) return "day";
      return "night";
    })();

    const currentTheme = status.theme === "auto" ? autoTheme : status.theme;
    const theme = themes[currentTheme] || themes.night;

    if (!status.enabled || now < until) {
      document.body.innerHTML = `
        <div style="
          background:${theme.bg};
          color:${theme.color};
          text-align:center;
          padding:60px;
          font-family:Arial,sans-serif;
        ">
          <h1 style="font-size:2em;">${theme.icon} ${status.message}</h1>
          <p style="font-size:1.2em;">${theme.tagline}</p>
          <p style="margin-top:20px;font-style:italic;">–ö–æ–º–∞–Ω–¥–∞ Genesis –≥–æ—Ç–æ–≤–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶</p>
        </div>
      `;
    }
  });
</script>
</body>
</html>
