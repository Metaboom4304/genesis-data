<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #000;
    }
    #map {
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
    }
    #panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #111;
      color: #fff;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      padding: 8px 10px;
      gap: 10px;
      z-index: 1000;
    }
    #panel select,
    #panel input,
    #panel button {
      font-size: 14px;
      padding: 5px;
    }
    #panel label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #search {
      width: 100px;
      color: #fff;
      background: #222;
      border: 1px solid #444;
    }
    #search::placeholder {
      color: #aaa;
    }
    button.mark-btn {
      margin: 5px 2px;
      padding: 3px 6px;
      font-size: 12px;
      cursor: pointer;
    }
    #goto-btn {
      font-size: 14px;
      padding: 5px 8px;
      background: #444;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      #panel {
        flex-direction: column;
        align-items: flex-start;
      }
      #map {
        top: 220px;
      }
    }
  </style>
</head>
<body>
  <div id="panel">
    <strong>üß≠ GENESIS WAR MAP:</strong>
    <label>
      üîç <input type="number" id="search" placeholder="–ù–æ–º–µ—Ä —Ç–∞–π–ª–∞" />
      <button id="goto-btn">‚û°Ô∏è</button>
    </label>
    <label>
      ‚öôÔ∏è –†–µ—Å—É—Ä—Å:
      <select id="filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="iron">–ñ–µ–ª–µ–∑–æ</option>
        <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
        <option value="platinum">–ü–ª–∞—Ç–∏–Ω–∞</option>
        <option value="silver">–°–µ—Ä–µ–±—Ä–æ</option>
        <option value="copper">–ú–µ–¥—å</option>
        <option value="tungsten">–í–æ–ª—å—Ñ—Ä–∞–º</option>
        <option value="uranium">–£—Ä–∞–Ω</option>
        <option value="rare_earth_elements">–†–µ–¥–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã</option>
      </select>
    </label>
    <label>
      üéØ –ú–µ—Ç–∫–∞:
      <select id="status-filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="ally">üü© –¢–æ–ª—å–∫–æ —Å–æ—é–∑–Ω–∏–∫–∏</option>
        <option value="enemy">üü• –¢–æ–ª—å–∫–æ –≤—Ä–∞–≥–∏</option>
        <option value="clear">‚ö™ –ë–µ–∑ –º–µ—Ç–∫–∏</option>
      </select>
    </label>
    <label>
      üó∫Ô∏è –°–ª–æ–π:
      <select id="layer-select">
        <option value="world">–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</option>
        <option value="osm">OpenStreetMap</option>
        <option value="carto">Carto Dark</option>
      </select>
    </label>
    <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="export">üíæ –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <span id="count">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–æ–≤‚Ä¶</span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
;(async function(){
  // 1) –°–ª–æ–∏
  const layers = {
    world: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png'),
    osm:   L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
    carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
  };
  const map = L.map('map', {
    center: [49.25, -123.10],
    zoom: 4,
    layers: [layers.world],
    minZoom: 2,
    maxZoom: 8
  });
  const tileLayer = L.layerGroup().addTo(map);
  document.getElementById('layer-select').onchange = e => {
    Object.values(layers).forEach(l=>map.removeLayer(l));
    layers[e.target.value].addTo(map);
  };

  // 2) –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  const PARTS = Array.from({length:22},(_,i)=>
    `./data/tiles_${String(i+1).padStart(2,'0')}.json`
  );
  let tileData = [];
  for(const url of PARTS){
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error(res.status);
      const json = await res.json();
      tileData.push(...json);
    } catch(err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', url, err);
    }
  }
  document.getElementById('count').textContent =
    `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∞–π–ª–æ–≤: ${tileData.length}`;

  // 3) –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É tile #22313
  const refTileId = 22313;
  const refX = refTileId % 256;
  const refY = Math.floor(refTileId / 256);
  const refLat = 49.25;
  const refLng = -123.10;
  const degLat = 170 / 256;    // ‚âà0.6640625
  const degLng = 360 / 256;    // ‚âà1.40625

  tileData.forEach(t=>{
    const id = parseInt(t.id_tile,10);
    const x0 = id % 256;
    const y0 = Math.floor(id / 256);
    t.x = x0;
    t.y = y0;
    const dx = x0 - refX;
    const dy = y0 - refY;
    t.lat = refLat - dy*degLat;
    t.lng = refLng + dx*degLng;
  });

  // 4) –•—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ—Ç–æ–∫
  const savedMarks = JSON.parse(localStorage.getItem('tile_marks')||'{}');
  window.saveMark = function(id,status){
    if(status) savedMarks[id] = status;
    else delete savedMarks[id];
    localStorage.setItem('tile_marks', JSON.stringify(savedMarks));
    drawTiles();
  };

  // 5) –û—Ç—Ä–∏—Å–æ–≤–∫–∞
  function drawTiles(){
    tileLayer.clearLayers();
    const resourceFilter = document.getElementById('filter').value;
    const statusFilter   = document.getElementById('status-filter').value;
    const searchID       = parseInt(document.getElementById('search').value);

    tileData.forEach(t=>{
      if(resourceFilter && +t[resourceFilter]===0) return;
      const status = savedMarks[t.id_tile]||'';
      if(statusFilter==='ally'  && status!=='ally') return;
      if(statusFilter==='enemy' && status!=='enemy') return;
      if(statusFilter==='clear' && status  ) return;
      if(!isNaN(searchID) && +t.id_tile!==searchID) return;

      const bounds = L.latLngBounds(
        [t.lat - degLat/2, t.lng - degLng/2],
        [t.lat + degLat/2, t.lng + degLng/2]
      );
      const owned = String(t.has_owner).toLowerCase()==='true';
      const fillColor = status==='ally' ? '#33cc33'
                      : status==='enemy'? '#cc3333'
                      : owned? '#3366ff'
                      : '#666666';
      const outline = status==='ally' ? '#00ff00'
                    : status==='enemy'? '#ff0000'
                    : '#000000';

      L.rectangle(bounds, {
        weight: 3,
        color: outline,
        dashArray: status? '4': null,
        fillOpacity: 0.5,
        fillColor
      })
      .bindPopup(`
        <strong>–¢–∞–π–ª #${t.id_tile}</strong><br>
        –ö–æ–æ—Ä–¥: ${t.lat.toFixed(2)}, ${t.lng.toFixed(2)}<br>
        –í–ª–∞–¥–µ–ª–µ—Ü: ${owned? '‚úÖ':'‚Äî'}<br>
        –°—Ç–∞—Ç—É—Å: ${status|| '‚Äî'}<br>
        ${['iron','gold','platinum','silver','copper','tungsten','uranium','rare_earth_elements']
          .filter(r=> +t[r]>0)
          .map(r=>`‚Ä¢ ${r}: ${t[r]}`).join('<br>')|| '–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤'}
        <br><br>
        <button class="mark-btn" onclick="saveMark('${t.id_tile}','ally')">
          üü© –°–æ—é–∑–Ω–∏–∫
        </button>
        <button class="mark-btn" onclick="saveMark('${t.id_tile}','enemy')">
          üü• –í—Ä–∞–≥
        </button>
        <button class="mark-btn" onclick="saveMark('${t.id_tile}','')">
          ‚ö™ –°–±—Ä–æ—Å–∏—Ç—å
        </button>
      `)
      .addTo(tileLayer);
    });
  }

  // 6) –§–æ–∫—É—Å –ø–æ ID + —Å–æ–±—ã—Ç–∏—è
  function focusTile(idStr){
    const id = parseInt(idStr,10);
    const t = tileData.find(o=>+o.id_tile===id);
    if(!t) return;
    map.flyTo([t.lat,t.lng],6);
    setTimeout(()=> {
      // –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ—Ç –∂–µ –ø–æ–ø–∞–ø, —á—Ç–æ –∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
      L.popup()
       .setLatLng([t.lat,t.lng])
       .setContent(
         document.querySelector(`button.mark-btn[onclick*="${id}"]`)
           .closest('.leaflet-popup-content').innerHTML
       )
       .openOn(map);
    },800);
  }
  document.getElementById('goto-btn').onclick = ()=> {
    const id = document.getElementById('search').value;
    if(id) focusTile(id);
  };
  ['input','change'].forEach(ev=>{
    document.getElementById('search').addEventListener(ev, drawTiles);
    document.getElementById('filter').addEventListener(ev, drawTiles);
    document.getElementById('status-filter').addEventListener(ev, drawTiles);
  });
  document.getElementById('reset').onclick = ()=> {
    document.getElementById('search').value     = '';
    document.getElementById('filter').value     = '';
    document.getElementById('status-filter').value = '';
    drawTiles();
  };
  document.getElementById('export').onclick = ()=>{
    const rows = [['id_tile','has_owner','status','resources']];
    tileData.forEach(t=>{
      const status = savedMarks[t.id_tile]||'';
      const resources = ['iron','gold','platinum','silver','copper','tungsten','uranium','rare_earth_elements']
        .filter(r=> +t[r]>0).join(',');
      rows.push([t.id_tile, t.has_owner, status, resources]);
    });
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'genesis_tiles.csv';
    a.click();
  };

  drawTiles();
})();
  </script>
</body>
</html>
