<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      font-family: sans-serif;
      overflow: hidden;
    }
    body:not(.logged-in) #panel,
    body:not(.logged-in) #map,
    body:not(.logged-in) #toggle-panel,
    body:not(.logged-in) #layer-select-small {
      display: none !important;
    }
    #login-container {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      color: #fff;
      z-index: 2000;
      text-align: center;
    }
    #login-button {
      margin-top: 1em;
      padding: 0.75em 1.5em;
      font-size: 1.1em;
      background: #0088cc;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      animation: pulse 2s infinite;
      width: 260px;
      max-width: 80%;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    #panel {
      position: absolute;
      top: 0; left: 0; right: 0;
      background: #111;
      color: #fff;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      padding: 8px;
      gap: 8px;
      z-index: 1000;
      max-height: 300px;
      overflow: hidden;
      transition: max-height 0.3s ease, background 0.3s ease;
    }
    #panel.collapsed { max-height: 40px; background: transparent !important; }
    #panel.collapsed *:not(#map-title) { display: none !important; }
    .search-wrapper { position: relative; display: flex; align-items: center; }
    #search { width: 120px; padding-right: 20px; box-sizing: border-box; }
    #search-clear {
      position: absolute;
      right: 4px;
      cursor: pointer;
      color: #ccc;
      font-size: 18px;
      user-select: none;
    }
    .tile-label {
      background: rgba(0,0,0,0.5);
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
    }
    #favorites-list button {
      margin-left: 5px;
      cursor: pointer;
      background: #333;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 2px 5px;
    }
    .tile-popup-button {
      margin: 2px;
      padding: 4px 8px;
      cursor: pointer;
      background: #444;
      color: white;
      border: none;
      border-radius: 3px;
    }
    .tile-popup-button:hover {
      background: #555;
    }
    .tile-popup-textarea {
      width: 100%;
      min-height: 60px;
      margin: 5px 0;
      padding: 5px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="login-container">
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GENESIS WAR MAP</h1>
    <button id="login-button">üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
  </div>

  <div id="panel">
    <strong id="map-title">üß≠ GENESIS WAR MAP</strong>

    <div class="search-wrapper">
      <input type="text" id="search" placeholder="–¢–∞–π–ª-ID" />
      <span id="search-clear">√ó</span>
      <button id="goto-btn">‚û°Ô∏è</button>
    </div>

    <label>
      üéØ –ú–µ—Ç–∫–∞:
      <select id="status-filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="ally">üü© –°–æ—é–∑–Ω–∏–∫</option>
        <option value="enemy">üü• –í—Ä–∞–≥</option>
        <option value="favorite">‚≠êÔ∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</option>
        <option value="clear">‚ö™Ô∏è –ë–µ–∑ –º–µ—Ç–∫–∏</option>
      </select>
    </label>

    <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="screenshot-btn">üì∏ –°–Ω–∏–º–æ–∫</button>

    <div id="favorites-container">
      <h4>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h4>
      <ul id="favorites-list"></ul>
    </div>
  </div>

  <div id="map"></div>

  <button id="toggle-panel">üîΩ</button>
  <select id="layer-select-small">
    <option value="neutral">N</option>
    <option value="world">W</option>
    <option value="satellite">S</option>
  </select>

  <!-- –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –±–ª–æ–∫ -->
  <div id="debug" style="
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #000; color: #0f0;
      font-size: 12px; padding: 10px;
      z-index: 9999; max-height: 50vh;
      overflow: auto; font-family: monospace;
    ">
    <div id="tg-status">Telegram WebApp: ‚è≥</div>
    <div id="user-status">User: ‚è≥</div>
    <div id="map-status">Map: ‚è≥</div>
    <div id="error-log">Errors: ‚è≥</div>
    <div style="margin:10px 0; border-top:1px solid #0f0;"></div>
    <div id="debug-log" style="max-height:120px; overflow:auto;"></div>
  </div>

  <!-- SDK –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://telegram.org/js/telegram-web-app.js" defer></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  
  <!-- –í–µ—Å—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ -->
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let map, gridLayer, tileLayer, saved = {}, favs = [], comments = {};
    let tileData = [];
    const degLat = 170/256, degLng = 360/256;
    const tileMarkers = {}; // –ö—ç—à –º–∞—Ä–∫–µ—Ä–æ–≤

    // –õ–æ–≥ –≤ debug-–æ–∫–Ω–æ
    function log(msg, isError = false) {
      const el = document.getElementById('debug-log');
      if (el) {
        el.innerHTML += `<span class="${isError ? 'error' : ''}">${msg}</span><br>`;
        el.scrollTop = el.scrollHeight;
      }
      if (isError) console.error(msg);
      else console.log(msg);
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function syncUser(user) {
      try {
        const { error } = await window.supabase
          .from('users')
          .upsert([{
            telegram_id: user.id,
            first_name: user.first_name,
            last_name: user.last_name,
            username: user.username
          }], { onConflict: 'telegram_id' });

        if (error) throw error;
        log('üíæ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω');
      } catch (e) {
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${e.message}`, true);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    async function initMap(user) {
      try {
        document.getElementById('login-container')?.remove();
        log('üü¢ initMap() –∑–∞–ø—É—â–µ–Ω–∞');
        log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user?.id || 'test-user'}`);

        // –°–ª—É—á–∞–π–Ω—ã–π —Å–ª–æ–≥–∞–Ω
        const phrases = [
          '–ö–∞–∂–¥—ã–π —Ö–æ–¥ –≤–∞–∂–µ–Ω',
          '–ú–æ—â—å –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö',
          '–ü–æ–±–µ–¥–∞ –∑–∞ –≥—Ä–∞–Ω—å—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞',
          '–¢–≤–æ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ',
          '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—É',
          '–ö–æ–º–∞–Ω–¥—É–π —Å –≤—ã—Å–æ—Ç—ã'
        ];
        document.getElementById('map-title').textContent =
          `üß≠ GENESIS WAR MAP ‚Äî ${phrases[Math.floor(Math.random()*phrases.length)]}`;

        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
        map = L.map('map', {
          center: [49.25, -123.10],
          zoom: 6,
          minZoom: 3,
          maxZoom: 10,
          attributionControl: false,
          zoomControl: false
        });
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
        log('üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');

        // –ë–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏
        const layers = {
          neutral: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
          world: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png'),
          satellite: L.tileLayer(
            'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            { attribution: 'Esri' }
          )
        };
        layers.neutral.addTo(map);
        
        document.getElementById('layer-select-small').onchange = e => {
          Object.values(layers).forEach(l => map.removeLayer(l));
          layers[e.target.value].addTo(map);
        };

        // –ì—Ä—É–ø–ø—ã —Å–ª–æ–µ–≤
        gridLayer = L.layerGroup().addTo(map);
        tileLayer = L.layerGroup().addTo(map);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const countEl = document.createElement('div');
        Object.assign(countEl.style, {
          position:'absolute', top:'50%', left:'50%',
          transform:'translate(-50%,-50%)',
          color:'#fff', zIndex:1000, background:'rgba(0,0,0,0.7)',
          padding:'10px', borderRadius:'5px'
        });
        countEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–æ–≤‚Ä¶';
        document.body.append(countEl);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—Å—Ç—è–º
        try {
          for (let i = 1; i <= 22; i++) {
            const url = `./data/tiles_${String(i).padStart(2,'0')}.json`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ ${res.status}`);
            tileData.push(...await res.json());
            countEl.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${tileData.length} —Ç–∞–π–ª–æ–≤`;
          }
        } catch (err) {
          log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, true);
          alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + err.message);
        }
        
        setTimeout(() => countEl.remove(), 1500);

        // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–π–ª–∞
        const refId = 22313, refLat = 49.25, refLng = -123.10;
        const refX = refId % 256, refY = Math.floor(refId/256);
        tileData.forEach(t => {
          const x = t.id_tile % 256, y = Math.floor(t.id_tile/256);
          t.lat = refLat - (y - refY)*degLat;
          t.lng = refLng + (x - refX)*degLng;
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏
        saved = JSON.parse(localStorage.getItem('tile_marks') || {};
        favs = JSON.parse(localStorage.getItem('favorites') || []);
        comments = JSON.parse(localStorage.getItem('comments') || {});

        // –ü–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        renderFavorites();
        drawGrid();
        drawTiles();
        
      } catch (error) {
        log(`‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ initMap: ${error.message}`, true);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã');
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
    function saveMark(id, status) {
      if (status) saved[id] = status;
      else delete saved[id];
      localStorage.setItem('tile_marks', JSON.stringify(saved));
      updateTile(id);
    }

    function saveComment(id) {
      const txt = document.querySelector(`#comment-${id}`)?.value.trim();
      if (txt) comments[id] = txt;
      else delete comments[id];
      localStorage.setItem('comments', JSON.stringify(comments));
      updateTile(id);
    }

    function toggleFav(id) {
      const tile = tileData.find(t => t.id_tile === id);
      if (!tile) return;
      
      const idx = favs.findIndex(f => f.id === id);
      if (idx < 0) {
        favs.push({ id, label: `#${id}` });
      } else {
        favs.splice(idx, 1);
      }
      localStorage.setItem('favorites', JSON.stringify(favs));
      renderFavorites();
      updateTile(id);
    }

    function goToFav(id) {
      const t = tileData.find(o => o.id_tile === id);
      if (!t) return;
      map.flyTo([t.lat, t.lng], 6, { animate: true, duration: 1 });
      setTimeout(() => {
        drawGrid();
        drawTiles();
      }, 800);
    }

    function renderFavorites() {
      const favList = document.getElementById('favorites-list');
      if (!favList) return;
      
      favList.innerHTML = favs.map(f => `
        <li data-id="${f.id}">
          ${f.label}
          <button class="goto-fav" data-id="${f.id}">‚û°Ô∏è</button>
          <button class="remove-fav" data-id="${f.id}">√ó</button>
        </li>
      `).join('');
    }

    // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    function drawGrid() {
      gridLayer.clearLayers();
      const vb = map.getBounds();
      
      tileData.forEach(t => {
        if (!vb.contains([t.lat, t.lng])) return;
        
        const b = L.latLngBounds(
          [t.lat - degLat/2, t.lng - degLng/2],
          [t.lat + degLat/2, t.lng + degLng/2]
        );
        
        L.rectangle(b, {
          stroke: true,
          weight: 0.6,
          color: '#666',
          fill: false
        }).addTo(gridLayer);
      });
    }

    function createTileMarker(t) {
      const b = L.latLngBounds(
        [t.lat - degLat/2, t.lng - degLng/2],
        [t.lat + degLat/2, t.lng + degLng/2]
      );
      
      const st = saved[t.id_tile] || '';
      const owned = String(t.has_owner).toLowerCase() === 'true';
      const isFav = favs.some(f => f.id === t.id_tile);
      
      const fill = st === 'ally' ? '#33cc33'
                : st === 'enemy' ? '#cc3333'
                : st === 'favorite' ? '#ff0'
                : owned ? '#3366ff' : '#444';
                
      const stroke = st === 'ally' ? '#00ff00'
                  : st === 'enemy' ? '#ff0000'
                  : st === 'favorite' ? '#ff0' : '#000';

      const rect = L.rectangle(b, {
        stroke: true,
        weight: 1.2,
        color: stroke,
        dashArray: st ? '4' : null,
        fillColor: fill,
        fillOpacity: 0.4
      });

      // –î–æ–±–∞–≤–ª—è–µ–º tooltip
      const zoom = map.getZoom();
      if (zoom >= 5) {
        rect.bindTooltip(String(t.id_tile), {
          permanent: true,
          direction: 'center',
          className: 'tile-label'
        });
      }

      // –°–æ–∑–¥–∞–µ–º popup
      const popupContent = document.createElement('div');
      popupContent.innerHTML = `
        <strong>–¢–∞–π–ª #${t.id_tile}</strong><br/>
        –°—Ç–∞—Ç—É—Å: ${owned ? '–∑–∞–Ω—è—Ç' : '—Å–≤–æ–±–æ–¥–µ–Ω'}<br/>
        –ú–µ—Ç–∫–∞: ${st || '‚Äî'}<br/>
        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comments[t.id_tile] || '‚Äî'}<br/>
      `;
      
      const buttons = document.createElement('div');
      buttons.style.margin = '10px 0';
      
      ['ally', 'enemy', 'favorite', 'clear'].forEach(status => {
        const btn = document.createElement('button');
        btn.className = 'tile-popup-button';
        btn.dataset.status = status;
        btn.dataset.id = t.id_tile;
        btn.textContent = 
          status === 'ally' ? 'üü© –°–æ—é–∑–Ω–∏–∫' :
          status === 'enemy' ? 'üü• –í—Ä–∞–≥' :
          status === 'favorite' ? '‚≠êÔ∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : '‚ö™Ô∏è –°–±—Ä–æ—Å';
        buttons.appendChild(btn);
      });
      
      const favBtn = document.createElement('button');
      favBtn.className = 'tile-popup-button';
      favBtn.dataset.id = t.id_tile;
      favBtn.textContent = isFav ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
      buttons.appendChild(favBtn);
      
      const textarea = document.createElement('textarea');
      textarea.id = `comment-${t.id_tile}`;
      textarea.className = 'tile-popup-textarea';
      textarea.placeholder = '–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...';
      textarea.value = comments[t.id_tile] || '';
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'tile-popup-button';
      saveBtn.dataset.id = t.id_tile;
      saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
      
      popupContent.appendChild(buttons);
      popupContent.appendChild(textarea);
      popupContent.appendChild(saveBtn);
      
      rect.bindPopup(popupContent);
      rect.on('click', () => rect.openPopup());
      
      return rect;
    }

    function updateTile(id) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
      if (tileMarkers[id]) {
        tileLayer.removeLayer(tileMarkers[id]);
        delete tileMarkers[id];
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π
      const tile = tileData.find(t => t.id_tile === id);
      if (!tile) return;
      
      const marker = createTileMarker(tile);
      tileMarkers[id] = marker;
      tileLayer.addLayer(marker);
    }

    function drawTiles() {
      const filter = document.getElementById('status-filter').value;
      const vb = map.getBounds();
      const searchValue = document.getElementById('search').value.trim();
      
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
      tileLayer.clearLayers();
      tileMarkers = {};
      
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–π–ª–æ–≤
      const filteredTiles = tileData.filter(t => {
        const st = saved[t.id_tile] || '';
        
        if (filter === 'ally' && st !== 'ally') return false;
        if (filter === 'enemy' && st !== 'enemy') return false;
        if (filter === 'favorite' && st !== 'favorite') return false;
        if (filter === 'clear' && st) return false;
        if (searchValue && String(t.id_tile) !== searchValue) return false;
        
        return true;
      });
      
      // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤–∏–¥–∏–º—ã—Ö —Ç–∞–π–ª–æ–≤
      filteredTiles.forEach(t => {
        if (!vb.contains([t.lat, t.lng]) return;
        const marker = createTileMarker(t);
        tileMarkers[t.id_tile] = marker;
        tileLayer.addLayer(marker);
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      // –ü–æ–∏—Å–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
      document.getElementById('search-clear').addEventListener('click', () => {
        document.getElementById('search').value = '';
        drawTiles();
      });

      document.getElementById('goto-btn').addEventListener('click', () => {
        const v = document.getElementById('search').value.trim();
        if (!v) return drawTiles();
        
        const t = tileData.find(o => +o.id_tile === +v);
        if (!t) return;
        
        map.flyTo([t.lat, t.lng], 6, { animate: true, duration: 1 });
        setTimeout(() => {
          drawGrid();
          drawTiles();
        }, 800);
      });

      document.getElementById('search').addEventListener('input', () => drawTiles());
      
      // –§–∏–ª—å—Ç—Ä—ã –∏ —Å–±—Ä–æ—Å
      document.getElementById('reset').addEventListener('click', () => {
        document.getElementById('search').value = '';
        document.getElementById('status-filter').value = '';
        drawGrid();
        drawTiles();
      });
      
      document.getElementById('status-filter').addEventListener('change', () => {
        drawGrid();
        drawTiles();
      });
      
      // –°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞
      document.getElementById('screenshot-btn').addEventListener('click', () => {
        html2canvas(document.getElementById('map')).then(canvas => {
          const link = document.createElement('a');
          link.href = canvas.toDataURL('image/png');
          link.download = 'map-screenshot.png';
          link.click();
        }).catch(e => {
          log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: ${e.message}`, true);
        });
      });
      
      // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
      document.getElementById('toggle-panel').addEventListener('click', () => {
        const panel = document.getElementById('panel');
        panel.classList.toggle('collapsed');
        this.textContent = panel.classList.contains('collapsed') ? 'üîº' : 'üîΩ';
      });
      
      // –°–æ–±—ã—Ç–∏—è –∫–∞—Ä—Ç—ã
      map.on('moveend', () => {
        drawGrid();
        drawTiles();
      });
      
      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ø–∞–ø–æ–≤
      map.on('popupopen', (e) => {
        const popup = e.popup;
        const content = popup.getElement();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤ popup
        content.addEventListener('click', (e) => {
          const target = e.target;
          if (!target.matches('.tile-popup-button')) return;
          
          const id = parseInt(target.dataset.id);
          
          if (target.dataset.status) {
            saveMark(id, target.dataset.status === 'clear' ? '' : target.dataset.status);
          } else if (target.textContent.includes('–∏–∑–±—Ä–∞–Ω–Ω')) {
            toggleFav(id);
          } else if (target.textContent.includes('–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π')) {
            saveComment(id);
          }
          
          popup.setContent(createTileMarker(tileData.find(t => t.id_tile === id)).getPopup().getContent());
        });
      });
      
      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      document.getElementById('favorites-list').addEventListener('click', (e) => {
        if (!e.target.matches('button')) return;
        
        const id = parseInt(e.target.dataset.id);
        if (e.target.classList.contains('goto-fav')) {
          goToFav(id);
        } else if (e.target.classList.contains('remove-fav')) {
          toggleFav(id);
        }
      });
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', async () => {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      const dbg = (id, msg) => {
        const e = document.getElementById(id);
        if (e) e.textContent = `${e.textContent.split(':')[0]}: ${msg}`;
      };
      
      try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        window.supabase = window.supabase.createClient(
          'https://nysjreargnvyjmcirinp.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55c2pyZWFyZ252eWptY2lyaW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDgxNDIsImV4cCI6MjA3MDM4NDE0Mn0.UzpiU_nM_ACF8bILAGF4oa-WSHaU38KX6Dtz_srZK9Q'
        );
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram
        const tg = window.Telegram?.WebApp;
        dbg('tg-status', tg ? '‚úÖ Loaded' : '‚ùå Not available');
        
        if (tg) {
          tg.ready();
          log('ü§ñ Telegram WebApp ready');
        }
        
        const tgUser = tg?.initDataUnsafe?.user || null;
        dbg('user-status', tgUser ? `‚úÖ ${tgUser.first_name} (${tgUser.id})` : '‚ùå No user');
        
        if (tgUser) {
          syncUser(tgUser);
          window.__tgUser = tgUser;
        } else {
          log('üë§ TG user: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (offline)');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.body.classList.add('logged-in');
        await initMap(tgUser || { id: 'test-user' });
        setupEventListeners();
        
        dbg('map-status', '‚úÖ Initialized');
        log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
      } catch (error) {
        dbg('error-log', `‚ùå ${error.message}`);
        log(`‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, true);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
      }
    });
  </script>
</body>
</html>
