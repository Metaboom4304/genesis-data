<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { position: absolute; top: 60px; left: 0; right: 0; bottom: 0; }
    #panel {
      position: absolute; top: 0; left: 0; right: 0;
      background: #111; color: white;
      display: flex; flex-wrap: wrap;
      align-items: center; padding: 8px 10px;
      gap: 10px; z-index: 1000;
    }
    #panel select, #panel input, #panel button {
      font-size: 14px; padding: 5px;
    }
    #panel label { display: flex; align-items: center; gap: 5px; }
    .tile-label {
      font-size: 10px;
      color: rgba(255,255,255,0.8);
      text-shadow: 0 0 2px black;
    }
    @media (max-width: 600px) {
      #panel { flex-direction: column; align-items: flex-start; }
      #map { top: 230px; }
    }
  </style>
</head>
<body>
  <div id="panel">
    <strong>üß≠ GENESIS WAR MAP:</strong> –ó–¥–µ—Å—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ç–≤–æ–µ–≥–æ –≥–æ—Å–ø–æ–¥—Å—Ç–≤–∞.
    <label>üîç ID: <input type="number" id="search" placeholder="12345" /></label>
    <label>‚öôÔ∏è –†–µ—Å—É—Ä—Å: 
      <select id="filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="iron">–ñ–µ–ª–µ–∑–æ</option>
        <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
        <option value="platinum">–ü–ª–∞—Ç–∏–Ω–∞</option>
        <option value="silver">–°–µ—Ä–µ–±—Ä–æ</option>
        <option value="copper">–ú–µ–¥—å</option>
        <option value="tungsten">–í–æ–ª—å—Ñ—Ä–∞–º</option>
        <option value="uranium">–£—Ä–∞–Ω</option>
        <option value="rare_earth_elements">–†–µ–¥–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã</option>
      </select>
    </label>
    <label>üéØ –°—Ç–∞—Ç—É—Å:
      <select id="mark-mode">
        <option value="">‚Äî –†–µ–∂–∏–º ‚Äî</option>
        <option value="ally">üü© –°–æ—é–∑–Ω–∏–∫</option>
        <option value="enemy">üü• –í—Ä–∞–≥</option>
        <option value="clear">‚ö™ –°–±—Ä–æ—Å–∏—Ç—å</option>
      </select>
    </label>
    <label>üó∫Ô∏è –°–ª–æ–π:
      <select id="layer-select">
        <option value="physical">–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
        <option value="osm">OpenStreetMap</option>
        <option value="dark">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</option>
      </select>
    </label>
    <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="export">üíæ –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <span id="count">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–æ–≤‚Ä¶</span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
(async function() {
  const layers = {
    physical: L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Map ¬© Esri' }
    ),
    osm: L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '¬© OpenStreetMap contributors' }
    ),
    dark: L.tileLayer(
      'https://tiles.stadiamaps.com/tiles/alidade_dark/{z}/{x}/{y}{r}.png',
      { attribution: '¬© Stadia Maps' }
    )
  };

  const map = L.map('map', {
    center: [0, 0],
    zoom: 2,
    minZoom: 0,
    maxZoom: 8,
    layers: [layers.physical]
  });

  const gridLayer = L.layerGroup().addTo(map);
  const tileLayer = L.layerGroup().addTo(map);

  document.getElementById('layer-select').addEventListener('change', e => {
    const selected = e.target.value;
    Object.values(layers).forEach(l => map.removeLayer(l));
    layers[selected].addTo(map);
  });

  const PARTS = Array.from({ length: 22 }, (_, i) =>
    `./data/tiles_${String(i+1).padStart(2,'0')}.json`
  );

  let tileData = [];
  try {
    const chunks = await Promise.all(PARTS.map(url => fetch(url).then(r => r.json())));
    tileData = chunks.flat();
    document.getElementById("count").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∞–π–ª–æ–≤: ${tileData.length}`;
  } catch(err) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:', err);
    return;
  }

  tileData.forEach(t => {
    const id = parseInt(t.id_tile, 10);
    const idx = id - 1;
    t.x = idx % 256;
    t.y = Math.floor(idx / 256);
  });

  const savedMarks = JSON.parse(localStorage.getItem('tile_marks') || '{}');
  function saveMark(id, status) {
    if (status) savedMarks[id] = status;
    else delete savedMarks[id];
    localStorage.setItem('tile_marks', JSON.stringify(savedMarks));
  }

  function drawGrid() {
    gridLayer.clearLayers();
    const z = map.getZoom(), s = 256;
    const b = map.getBounds();
    const nw = map.project(b.getNorthWest(), z);
    const se = map.project(b.getSouthEast(), z);
    const x0 = Math.floor(nw.x / s), x1 = Math.floor(se.x / s);
    const y0 = Math.floor(nw.y / s), y1 = Math.floor(se.y / s);

    for (let y = y0; y <= y1; y++) {
      for (let x = x0; x <= x1; x++) {
        const p0 = L.point(x*s, y*s);
        const p1 = L.point((x+1)*s, (y+1)*s);
        const rect = L.latLngBounds(map.unproject(p0, z), map.unproject(p1, z));
        L.rectangle(rect, {
          weight: 1,
          color: 'rgba(255,255,255,0.2)',
          interactive: false
        }).addTo(gridLayer);
        L.marker(rect.getCenter(), {
          icon: L.divIcon({
            className: 'tile-label',
            html: `${y}-${x}`,
            iconSize: [0, 0]
          }),
          interactive: false
        }).addTo(gridLayer);
      }
    }
  }

  function drawTiles() {
    tileLayer.clearLayers();
    const z = map.getZoom(), s = 256;
    const b = map.getBounds();
    const nw = map.project(b.getNorthWest(), z);
    const se = map.project(b.getSouthEast(), z);
    const x0 = Math.floor(nw.x / s), x1 = Math.floor(se.x / s);
    const y0 = Math.floor(nw.y / s), y1 = Math.floor(se.y / s);

    const resourceFilter = document.getElementById('filter').value;
    const searchID = parseInt(document.getElementById('search').value);

    tileData.forEach(t => {
      if (t.x < x0 || t.x > x1 || t.y < y0 || t.y > y1) return;
      if (resourceFilter && parseInt(t[resourceFilter]) === 0) return;
      if (!isNaN(searchID) && parseInt(t.id_tile) !== searchID) return;

      const p0 = L.point(t.x*s, t.y*s);
      const p1 = L.point((t.x+1)*s, (t.y+1)*s);
      const bounds = L.latLngBounds(map.unproject(p0, z), map.unproject(p1, z));
      const owned = String(t.has_owner).toLowerCase() === "true";
      const status = savedMarks[t.id_tile];

      const color = status === "ally" ? "#33cc33" :
                    status === "enemy" ? "#cc3333" :
                    owned ? "#ff4444" : "#444444";

      const resources = [
        'iron','gold','platinum','copper','silver','limestone',
        'aluminum','titanium','tungsten','uranium','rare_earth_elements'
      ].filter(r => parseInt(t[r]) > 0)
       .map(r => `‚Ä¢ ${r}: ${t[r]}`)
       .join('<br>');

      L.rectangle(bounds, {
        weight: 1,
        color: status === "ally" ? "#00ff00" :
               status === "enemy" ? "#ff0000" : "#000000",
        fillOpacity: 0.4,
        fillColor: color
      })
      .bindPopup(`
        <strong>–¢–∞–π–ª #${t.id_tile}</strong><br>
        –í–ª–∞–¥–µ–ª–µ—Ü: ${owned ? '‚úÖ' : '‚Äî'}<br>
        –°—Ç–∞—Ç—É—Å: ${status || '‚Äî'}<br>
        ${resources || '–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤'}
      `)
      .on('click', () => {
        const mode = document.getElementById('mark-mode').value;
        saveMark(t.id_tile, mode === 'clear' ? null : mode);
        drawTiles();
      })
      .addTo(tileLayer);
    });
  }

  document.getElementById('reset').addEventListener('click', () => {
    document.getElementById('search').value = '';
    document.getElementById('filter').value = '';
    document.getElementById('mark-mode').value = '';
    drawTiles();
  });

  document.getElementById('export').addEventListener('click', () => {
    const rows = [["id_tile","has_owner","status","resources"]];
    tileData.forEach(t => {
      const status = savedMarks[t.id_tile] || '';
      const resources = [
        'iron','gold','platinum','copper','silver','limestone',
        'aluminum','titanium','tungsten','uranium','rare_earth_elements'
      ].filter(r => parseInt(t[r]) > 0).join(",");
      rows.push([t.id_tile, t.has_owner, status, resources]);
    });
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "genesis_tiles.csv";
    a.click();
  });

  document.getElementById('filter').addEventListener('change', drawTiles);
  document.getElementById('search').addEventListener('input', drawTiles);
  document.getElementById('mark-mode').addEventListener('change', () => drawTiles());

  drawGrid();
  drawTiles();
  map.on('zoomend moveend', drawGrid);
  map.on('zoomend moveend', drawTiles);
})();
</script>
</body>
</html>
