<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ‚Äî Leaflet CSS ‚Äî -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />

  <style>
    /* ‚Äî Reset & full-screen ‚Äî */
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      font-family: sans-serif;
      overflow: hidden;
    }

    /* ‚Äî –°–∫—Ä—ã—Ç—å –¥–æ –ª–æ–≥–∏–Ω–∞ ‚Äî */
    body:not(.logged-in) #panel,
    body:not(.logged-in) #map,
    body:not(.logged-in) #toggle-panel,
    body:not(.logged-in) #layer-select-small {
      display: none !important;
    }

    /* ‚Äî Login Overlay ‚Äî */
    #login-container {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      z-index: 2000;
      text-align: center;
    }
    #login-container h1 {
      margin: 0;
      font-size: 1.5em;
    }
    #login-button {
      margin-top: 1em;
      padding: 0.75em 1.5em;
      font-size: 1.1em;
      background: #0088cc;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      animation: pulse 2s infinite;
      width: 260px;
      max-width: 80%;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50%      { transform: scale(1.05); }
    }

    /* ‚Äî –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî */
    #panel {
      position: absolute;
      top: 0; left: 0; right: 0;
      background: #111;
      color: #fff;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      padding: 8px;
      gap: 8px;
      z-index: 1000;
      max-height: 300px;
      overflow: hidden;
      transition: max-height 0.3s ease, background 0.3s ease;
    }
    #panel.collapsed {
      max-height: 40px;
      background: transparent !important;
    }
    #panel.collapsed *:not(#map-title) {
      display: none !important;
    }

    /* ‚Äî –ü–æ–∏—Å–∫ + –æ—á–∏—Å—Ç–∫–∞ ‚Äî */
    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    #search {
      width: 120px;
      padding-right: 20px;
      box-sizing: border-box;
    }
    #search-clear {
      position: absolute;
      right: 4px;
      cursor: pointer;
      color: #ccc;
      font-size: 18px;
      user-select: none;
    }

    /* ‚Äî Favorites ‚Äî */
    #favorites-container {
      max-height: 150px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.5);
      padding: 4px;
      border-radius: 4px;
      font-size: 14px;
    }
    #favorites-container h4 {
      margin: 4px 0;
      color: #fff;
    }
    #favorites-list {
      list-style: none;
      margin: 0; padding: 0;
    }
    #favorites-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2px 0;
      color: #fff;
    }
    #favorites-list button {
      background: none;
      border: none;
      color: #f90;
      cursor: pointer;
    }

    /* ‚Äî –ö–∞—Ä—Ç–∞ ‚Äî */
    #map {
      position: absolute;
      top: 60px; bottom: 0; left: 0; right: 0;
    }

    /* ‚Äî –°–Ω–∏–º–æ–∫, —Å–±—Ä–æ—Å ‚Äî */
    #reset, #screenshot-btn {
      cursor: pointer;
    }

    /* ‚Äî Toggle & Layer ‚Äî */
    #toggle-panel {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: #111;
      color: #fff;
      border: none;
      padding: 6px;
      border-radius: 4px;
      cursor: pointer;
    }
    #layer-select-small {
      position: absolute;
      bottom: 10px;
      right: 60px;
      z-index: 1000;
      width: 32px;
      height: 32px;
      background: #111;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Login Overlay -->
  <div id="login-container">
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GENESIS WAR MAP</h1>
    <button id="login-button">üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
  </div>

  <!-- Control Panel -->
  <div id="panel">
    <strong id="map-title">üß≠ GENESIS WAR MAP</strong>

    <div class="search-wrapper">
      <input type="text" id="search" placeholder="–¢–∞–π–ª-ID" />
      <span id="search-clear">√ó</span>
      <button id="goto-btn">‚û°Ô∏è</button>
    </div>

    <label>
      üéØ –ú–µ—Ç–∫–∞:
      <select id="status-filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="ally">üü© –°–æ—é–∑–Ω–∏–∫</option>
        <option value="enemy">üü• –í—Ä–∞–≥</option>
        <option value="favorite">‚≠êÔ∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</option>
        <option value="clear">‚ö™Ô∏è –ë–µ–∑ –º–µ—Ç–∫–∏</option>
      </select>
    </label>

    <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="screenshot-btn">üì∏ –°–Ω–∏–º–æ–∫</button>

    <div id="favorites-container">
      <h4>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h4>
      <ul id="favorites-list"></ul>
    </div>
  </div>

  <!-- Map & Toggles -->
  <div id="map"></div>
  <button id="toggle-panel">üîΩ</button>
  <select id="layer-select-small">
    <option value="neutral">N</option>
    <option value="world">W</option>
    <option value="satellite">S</option>
  </select>


  <!-- ================================
       –°–∫—Ä–∏–ø—Ç—ã –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫
  ================================ -->

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet & html2canvas -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
  <script type="module">
    // 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    import { syncUser } from './syncUser.js';
    const tg = window.Telegram?.WebApp;
    tg?.ready();
    const tgUser = tg?.initDataUnsafe?.user;
    if (tgUser) {
      syncUser(tgUser);
    }

    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ UI
    (function () {
      const loginContainer = document.getElementById('login-container');
      const loginBtn       = document.getElementById('login-button');
      const panel          = document.getElementById('panel');
      const toggle         = document.getElementById('toggle-panel');

      // 2.1 OpenLink –¥–ª—è –ª–æ–≥–∏–Ω–∞
      loginBtn.addEventListener('click', () => {
        if (!tg) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Telegram.');
          return;
        }
        if (tg.platform === 'unknown') {
          alert('Web App —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö Telegram.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
          return;
        }
        tg.openLink('https://t.me/Metaboom4304bot?start=webapp');
      });

      // 2.2 Collapse/expand –ø–∞–Ω–µ–ª–∏
      toggle.onclick = () => {
        const collapsed = panel.classList.toggle('collapsed');
        toggle.textContent = collapsed ? 'üîº' : 'üîΩ';
      };

      // 3. –§—É–Ω–∫—Ü–∏—è initMap –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      window.initMap = async function (user) {
        // –°–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π
        loginContainer.remove();
        document.body.classList.add('logged-in');

        // –†–∞–Ω–¥–æ–º–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const phrases = [
          '–ö–∞–∂–¥—ã–π —Ö–æ–¥ –≤–∞–∂–µ–Ω',
          '–ú–æ—â—å –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö',
          '–ü–æ–±–µ–¥–∞ –∑–∞ –≥—Ä–∞–Ω—å—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞',
          '–¢–≤–æ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ',
          '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—É',
          '–ö–æ–º–∞–Ω–¥—É–π —Å –≤—ã—Å–æ—Ç—ã'
        ];
        document.getElementById('map-title').textContent =
          `üß≠ GENESIS WAR MAP ‚Äî ${
            phrases[Math.floor(Math.random() * phrases.length)]
          }`;

        // 3.1 –†–∞–∑–º–µ—Ç–∫–∞ –∫–∞—Ä—Ç—ã
        const map = L.map('map', {
          center: [49.25, -123.10],
          zoom: 6,
          minZoom: 3,
          maxZoom: 10,
          attributionControl: false,
          zoomControl: false
        });
        map.zoomControl.setPosition('bottomleft');

        // 3.2 –°–ª–æ–∏
        const layers = {
          neutral:   L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
          world:     L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png'),
          satellite: L.tileLayer(
            'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            { attribution: 'Esri' }
          )
        };
        layers.neutral.addTo(map);

        document.getElementById('layer-select-small').onchange = e => {
          Object.values(layers).forEach(l => map.removeLayer(l));
          layers[e.target.value].addTo(map);
        };

        // 3.3 –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        const drawnMarkers = new Map();
        const gridLayer    = L.layerGroup().addTo(map);
        const tileLayer    = L.layerGroup().addTo(map);

        // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–π–ª–æ–≤
        let tileData = [];
        const countEl = document.createElement('div');
        countEl.style =
          'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);'
          + 'color:#fff;z-index:1000;';
        countEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–ª–æ–≤‚Ä¶';
        document.body.append(countEl);

        try {
          for (let i = 1; i <= 22; i++) {
            const url = `./data/tiles_${String(i).padStart(2,'0')}.json`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ ${res.status}`);
            tileData.push(...await res.json());
          }
        } catch (e) {
          alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
        }
        countEl.textContent = `–¢–∞–π–ª–æ–≤: ${tileData.length}`;
        setTimeout(() => countEl.remove(), 1500);

        // 5. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ id_tile ‚Üí lat,lng
        const refId  = 22313, refLat = 49.25, refLng = -123.10;
        const refX   = refId % 256, refY = Math.floor(refId / 256);
        const degLat = 170 / 256, degLng = 360 / 256;
        tileData.forEach(t => {
          const x = t.id_tile % 256, y = Math.floor(t.id_tile / 256);
          t.lat = refLat - (y - refY) * degLat;
          t.lng = refLng + (x - refX) * degLng;
        });

        // 6. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        let saved    = JSON.parse(localStorage.getItem('tile_marks') || '{}'),
            favs     = JSON.parse(localStorage.getItem('favorites') || '[]'),
            comments = JSON.parse(localStorage.getItem('comments') || '{}');

        function saveMark(id, status) {
          if (status) saved[id] = status; else delete saved[id];
          localStorage.setItem('tile_marks', JSON.stringify(saved));
          drawGrid(); drawTiles();
        }
        function saveComment(id) {
          const txt = document.getElementById(`comment-${id}`).value.trim();
          if (txt) comments[id] = txt; else delete comments[id];
          localStorage.setItem('comments', JSON.stringify(comments));
          drawTiles();
        }
        function toggleFav(id, label) {
          const idx = favs.findIndex(f => f.id === id);
          if (idx < 0) favs.push({ id, label });
          else favs.splice(idx, 1);
          localStorage.setItem('favorites', JSON.stringify(favs));
          renderFavorites(); drawTiles();
        }
        function renderFavorites() {
          document.getElementById('favorites-list').innerHTML = favs.map(f => `
            <li data-id="${f.id}">
              ${f.label}
              <button onclick="goToFav(${f.id})">‚û°Ô∏è</button>
              <button onclick="toggleFav(${f.id},'${f.label.replace(/'/g,"\\'")}')">√ó</button>
            </li>
          `).join('');
        }
        window.goToFav = id => {
          const t = tileData.find(o => o.id_tile === id);
          if (!t) return;
          map.flyTo([t.lat, t.lng], 6, { animate: true, duration: 1 });
          setTimeout(drawTiles, 800);
        };
        renderFavorites();

        // 7. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏ –∏ —Ç–∞–π–ª–æ–≤
        function drawGrid() {
          gridLayer.clearLayers();
          const vb = map.getBounds();
          tileData.forEach(t => {
            if (!vb.contains([t.lat, t.lng])) return;
            const b = L.latLngBounds(
              [t.lat - degLat/2, t.lng - degLng/2],
              [t.lat + degLat/2, t.lng + degLng/2]
            );
            L.rectangle(b, { stroke: true, weight: 0.6, color: '#666', fill: false })
             .addTo(gridLayer);
          });
        }

        function drawTiles() {
          tileLayer.clearLayers();
          const filter      = document.getElementById('status-filter').value,
                vb          = map.getBounds(),
                zoom        = map.getZoom(),
                searchValue = document.getElementById('search').value.trim();

          tileData.forEach(t => {
            const st = saved[t.id_tile] || '';
            if (filter === 'ally'     && st !== 'ally')     return;
            if (filter === 'enemy'    && st !== 'enemy')    return;
            if (filter === 'favorite' && st !== 'favorite') return;
            if (filter === 'clear'    && st)                return;
            if (!filter && !vb.contains([t.lat, t.lng]) && !searchValue) return;

            const b = L.latLngBounds(
              [t.lat - degLat/2, t.lng - degLng/2],
              [t.lat + degLat/2, t.lng + degLng/2]
            );
            const owned = String(t.has_owner).toLowerCase() === 'true';
            const fill  = st === 'ally'    ? '#33cc33'
                         : st === 'enemy'   ? '#cc3333'
                         : st === 'favorite'? '#ff0'
                         : owned            ? '#3366ff'
                                            : '#444';
            const stroke = st === 'ally'    ? '#00ff00'
                          : st === 'enemy'   ? '#ff0000'
                          : st === 'favorite'? '#ff0'
                                            : '#000';

            const rect = L.rectangle(b, {
              stroke: true,
              weight: 1.2,
              color: stroke,
              dashArray: st ? '4' : null,
              fillColor: fill,
              fillOpacity: 0.4
            }).addTo(tileLayer);

            if (zoom >= 5) {
              rect.bindTooltip(String(t.id_tile), {
                permanent: true,
                direction: 'center',
                className: 'tile-label'
              });
            }

            const isFav = !!favs.find(f => f.id === t.id_tile);
            const label = `#${t.id_tile}`;
            const popupHtml = `
              <strong>–¢–∞–π–ª ${label}</strong><br/>
              –°—Ç–∞—Ç—É—Å: ${owned ? '–∑–∞–Ω—è—Ç' : '—Å–≤–æ–±–æ–¥–µ–Ω'}<br/>
              –ú–µ—Ç–∫–∞: ${st || '‚Äî'}<br/>
              –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comments[t.id_tile] || '‚Äî'}<br/><br/>
              <button onclick="saveMark(${t.id_tile},'ally')">üü©</button>
              <button onclick="saveMark(${t.id_tile},'enemy')">üü•</button>
              <button onclick="saveMark(${t.id_tile},'favorite')">‚≠êÔ∏è</button>
              <button onclick="saveMark(${t.id_tile},'')">‚ö™Ô∏è</button><br/><br/>
              <button onclick="toggleFav(${t.id_tile},'${label}')">
                ${isFav ? '–£–¥–∞–ª–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–î–æ–±–∞–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}
              </button><br/><br/>
              <textarea id="comment-${t.id_tile}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
              <button onclick="saveComment(${t.id_tile})">üíæ</button>
            `;
            rect.bindPopup(popupHtml);
            rect.on('click', () => rect.openPopup());
          });
        }

        // 8. –ü–æ–∏—Å–∫ –∏ –æ—á–∏—Å—Ç–∫–∞
        document.getElementById('search-clear').onclick = () => {
          document.getElementById('search').value = '';
          drawTiles();
        };
        document.getElementById('goto-btn').onclick = () => {
          const v = document.getElementById('search').value.trim();
          if (!v) return drawTiles();
          const t = tileData.find(o => +o.id_tile === +v);
          if (!t) return;
          map.flyTo([t.lat, t.lng], 6, { animate: true, duration: 1 });
          setTimeout(drawTiles, 800);
        };
        document.getElementById('search').addEventListener('input', () => drawTiles());

        // 9. –°–±—Ä–æ—Å –∏ —Å–Ω–∏–º–æ–∫
        document.getElementById('reset').onclick = () => {
          document.getElementById('search').value       = '';
          document.getElementById('status-filter').value = '';
          drawGrid(); drawTiles();
        };
        document.getElementById('screenshot-btn').onclick = () => {
          html2canvas(document.getElementById('map')).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'map.png';
            link.click();
          });
        };

        // 10. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
        map.on('moveend', () => { drawGrid(); drawTiles(); });

        // 11. –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
        drawGrid();
        drawTiles();
      };

      // –ê–≤—Ç–æ-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      if (tg && tg.initDataUnsafe) {
        window.initMap(tg.initDataUnsafe.user);
      }
    })();
  </script>
</body>
</html>
