<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Genesis Map — Карта тайлов</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .tile-label {
      font-size: 10px;
      color: rgba(255,255,255,0.8);
      text-shadow: 0 0 2px black;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
  (async function(){
    const map = L.map('map', {
      center: [0, 0],
      zoom: 2,
      minZoom: 0,
      maxZoom: 8
    });

    // Фоновая карта (ArcGIS Physical Map)
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Map © Esri'
    }).addTo(map);

    const gridLayer = L.layerGroup().addTo(map);
    const tileLayer = L.layerGroup().addTo(map);

    // Загружаем 22 JSON-файла с тайлами
    const PARTS = Array.from({ length: 22 }, (_, i) =>
      `./data/tiles_${String(i+1).padStart(2,'0')}.json`
    );

    let tileData = [];
    try {
      const chunks = await Promise.all(
        PARTS.map(url => fetch(url).then(r => r.json()))
      );
      tileData = chunks.flat();
      console.log('Загружено тайлов:', tileData.length);
    } catch(err) {
      console.error('Ошибка загрузки JSON:', err);
      return;
    }

    // Вычисляем координаты x, y
    tileData.forEach(t => {
      const id = parseInt(t.number, 10);
      const idx = id - 1;
      t.x = idx % 256;
      t.y = Math.floor(idx / 256);
    });

    // Отрисовка сетки тайлов
    function drawGrid() {
      gridLayer.clearLayers();
      const z = map.getZoom(), s = 256;
      const b = map.getBounds();
      const nw = map.project(b.getNorthWest(), z);
      const se = map.project(b.getSouthEast(), z);
      const x0 = Math.floor(nw.x / s), x1 = Math.floor(se.x / s);
      const y0 = Math.floor(nw.y / s), y1 = Math.floor(se.y / s);

      for (let y = y0; y <= y1; y++) {
        for (let x = x0; x <= x1; x++) {
          const p0 = L.point(x*s, y*s);
          const p1 = L.point((x+1)*s, (y+1)*s);
          const rect = L.latLngBounds(
            map.unproject(p0, z), map.unproject(p1, z)
          );
          L.rectangle(rect, {
            weight: 1,
            color: 'rgba(255,255,255,0.2)',
            interactive: false
          }).addTo(gridLayer);
          L.marker(rect.getCenter(), {
            icon: L.divIcon({
              className: 'tile-label',
              html: `${y}-${x}`,
              iconSize: [0, 0]
            }),
            interactive: false
          }).addTo(gridLayer);
        }
      }
    }

    // Отрисовка закрашенных тайлов с инфой
    function drawTiles() {
      tileLayer.clearLayers();
      const z = map.getZoom(), s = 256;
      tileData.forEach(t => {
        const p0 = L.point(t.x*s, t.y*s);
        const p1 = L.point((t.x+1)*s, (t.y+1)*s);
        const bounds = L.latLngBounds(
          map.unproject(p0, z), map.unproject(p1, z)
        );
        const owned = t.has_owner === true || t.has_owner === 'true';

        L.rectangle(bounds, {
          weight: 0,
          fillOpacity: 0.4,
          fillColor: owned ? '#ff4444' : '#444444'
        })
        .bindPopup(`
          <strong>Тайл #${t.number}</strong><br>
          Владелец: ${t.owner || '—'}<br>
          Клан: ${t.clan_tile}<br>
          Шахты: ${t.mines}
        `)
        .addTo(tileLayer);
      });
    }

    // Первая отрисовка и обновление при движении/зуме
    drawGrid();
    drawTiles();
    map.on('zoomend moveend', drawGrid);
    map.on('zoomend', drawTiles);
  })();
  </script>
</body>
</html>
