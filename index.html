<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GENESIS WAR MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  
  <style>
    /* ... (–≤–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
    
    /* –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 10000;
      text-align: center;
    }
    
    .loader-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      margin: 10px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="login-container">
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GENESIS WAR MAP</h1>
    <button id="login-button">üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
  </div>

  <div id="panel">
    <strong id="map-title">üß≠ GENESIS WAR MAP</strong>

    <div class="search-wrapper">
      <input type="text" id="search" placeholder="–¢–∞–π–ª-ID" />
      <span id="search-clear">√ó</span>
      <button id="goto-btn">‚û°Ô∏è</button>
    </div>

    <label>
      üéØ –ú–µ—Ç–∫–∞:
      <select id="status-filter">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="ally">üü© –°–æ—é–∑–Ω–∏–∫</option>
        <option value="enemy">üü• –í—Ä–∞–≥</option>
        <option value="favorite">‚≠êÔ∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</option>
        <option value="clear">‚ö™Ô∏è –ë–µ–∑ –º–µ—Ç–∫–∏</option>
      </select>
    </label>

    <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="screenshot-btn">üì∏ –°–Ω–∏–º–æ–∫</button>

    <div id="favorites-container">
      <h4>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h4>
      <ul id="favorites-list"></ul>
    </div>
  </div>

  <div id="map"></div>

  <button id="toggle-panel">üîΩ</button>
  <select id="layer-select-small">
    <option value="neutral">N</option>
    <option value="world">W</option>
    <option value="satellite">S</option>
  </select>

  <!-- –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –±–ª–æ–∫ -->
  <div id="debug" style="
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #000; color: #0f0;
      font-size: 12px; padding: 10px;
      z-index: 9999; max-height: 50vh;
      overflow: auto; font-family: monospace;
    ">
    <div id="tg-status">Telegram WebApp: ‚è≥</div>
    <div id="user-status">User: ‚è≥</div>
    <div id="map-status">Map: ‚è≥</div>
    <div id="cache-status">Cache: ‚è≥</div>
    <div id="error-log">Errors: ‚è≥</div>
    <div style="margin:10px 0; border-top:1px solid #0f0;"></div>
    <div id="debug-log" style="max-height:120px; overflow:auto;"></div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let map, gridLayer, tileLayer;
    let tileData = []; // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–π–ª–æ–≤
    let tileDynamicData = {}; // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–π–ª–æ–≤ (–∫–µ—à)
    let userMarks = {}; // –ú–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const degLat = 170/256, degLng = 360/256;
    const tileMarkers = {}; // –ö—ç—à –º–∞—Ä–∫–µ—Ä–æ–≤
    const CACHE_TTL = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    let currentUser = null;
    let supabase;

    // –õ–æ–≥ –≤ debug-–æ–∫–Ω–æ
    function log(msg, isError = false) {
      const el = document.getElementById('debug-log');
      if (el) {
        el.innerHTML += `<span class="${isError ? 'error' : ''}">${new Date().toLocaleTimeString()}: ${msg}</span><br>`;
        el.scrollTop = el.scrollHeight;
      }
      if (isError) console.error(msg);
      else console.log(msg);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    function initSupabase() {
      supabase = window.supabase.createClient(
        'https://nysjreargnvyjmcirinp.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55c2pyZWFyZ252eWptY2lyaW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDgxNDIsImV4cCI6MjA3MDM4NDE0Mn0.UZpiU_nM_ACF8bILAGF4oa-WSHaU38KX6Dtz_srZK9Q'
      );
      log('‚úÖ Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function syncUser(user) {
      try {
        const { error } = await supabase
          .from('users')
          .upsert([{
            telegram_id: user.id,
            first_name: user.first_name,
            last_name: user.last_name,
            username: user.username,
            last_login: new Date().toISOString()
          }], { onConflict: 'telegram_id' });
        
        if (error) throw error;
        log('üíæ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å Supabase');
      } catch (e) {
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${e.message}`, true);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUserMarks() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase
          .from('user_marks')
          .select('tile_id, mark_type, comment')
          .eq('user_id', currentUser.id);
        
        if (error) throw error;
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        userMarks = {};
        data.forEach(mark => {
          if (!userMarks[mark.tile_id]) userMarks[mark.tile_id] = {};
          userMarks[mark.tile_id][mark.mark_type] = mark.comment || true;
        });
        
        log(`üìå –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫`);
        return true;
      } catch (e) {
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–æ–∫: ${e.message}`, true);
        return false;
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function saveUserMark(tile_id, mark_type, comment = null) {
      if (!currentUser) return false;
      
      try {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –º–µ—Ç–∫—É —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        await supabase
          .from('user_marks')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('tile_id', tile_id)
          .eq('mark_type', mark_type);
        
        // –ï—Å–ª–∏ –Ω–µ —Å–±—Ä–æ—Å - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
        if (mark_type !== 'clear') {
          const { error } = await supabase
            .from('user_marks')
            .insert([{
              user_id: currentUser.id,
              tile_id: tile_id,
              mark_type: mark_type,
              comment: comment,
              created_at: new Date().toISOString()
            }]);
          
          if (error) throw error;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
        if (!userMarks[tile_id]) userMarks[tile_id] = {};
        
        if (mark_type === 'clear') {
          delete userMarks[tile_id];
        } else {
          userMarks[tile_id][mark_type] = comment || true;
        }
        
        log(`üíæ –ú–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: ${tile_id} (${mark_type})`);
        return true;
      } catch (e) {
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∫–∏: ${e.message}`, true);
        return false;
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    async function loadDynamicData() {
      log('üîÉ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ —Ç–∞–π–ª–æ–≤...');
      document.getElementById('cache-status').textContent = 'Cache: üîÑ Loading';
      
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–µ–∂–∏–π –∫–µ—à –≤ Supabase
        const { data: cache, error } = await supabase
          .from('tiles_cache')
          .select('*')
          .order('last_updated', { ascending: false })
          .limit(1);
        
        let useCache = false;
        
        if (!error && cache.length > 0) {
          const cacheAge = new Date() - new Date(cache[0].last_updated);
          log(`‚ÑπÔ∏è –í–æ–∑—Ä–∞—Å—Ç –∫–µ—à–∞: ${Math.round(cacheAge/1000/60)} –º–∏–Ω.`);
          
          if (cacheAge < CACHE_TTL) {
            log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞');
            tileDynamicData = cache[0].data;
            document.getElementById('cache-status').textContent = `Cache: ‚úÖ ${new Date(cache[0].last_updated).toLocaleTimeString()}`;
            useCache = true;
          }
        }
        
        // –ï—Å–ª–∏ –∫–µ—à —É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        if (!useCache) {
          log('‚è¨ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞...');
          const response = await fetch('https://back.genesis-of-ages.space/manage/get_tile_info.php');
          
          if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
          }
          
          const data = await response.json();
          log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${Object.keys(data).length} –∑–∞–ø–∏—Å–µ–π`);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à Supabase
          const { error: cacheError } = await supabase
            .from('tiles_cache')
            .upsert([{
              last_updated: new Date().toISOString(),
              data: data
            }], { onConflict: 'last_updated' });
          
          if (cacheError) throw cacheError;
          log('üíæ –ö–µ—à –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Supabase');
          
          tileDynamicData = data;
          document.getElementById('cache-status').textContent = `Cache: ‚úÖ ${new Date().toLocaleTimeString()}`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
        drawTiles();
        return true;
      } catch (error) {
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${e.message}`, true);
        document.getElementById('cache-status').textContent = 'Cache: ‚ùå Error';
        return false;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    async function initMap(user) {
      try {
        currentUser = user;
        document.getElementById('login-container')?.remove();
        log('üü¢ initMap() –∑–∞–ø—É—â–µ–Ω–∞');
        log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user?.first_name || 'test-user'} (${user?.id || 'test'})`);
        document.getElementById('user-status').textContent = `User: ‚úÖ ${user?.first_name || 'test'}`;

        // –°–ª—É—á–∞–π–Ω—ã–π —Å–ª–æ–≥–∞–Ω
        const phrases = [
          '–ö–∞–∂–¥—ã–π —Ö–æ–¥ –≤–∞–∂–µ–Ω',
          '–ú–æ—â—å –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö',
          '–ü–æ–±–µ–¥–∞ –∑–∞ –≥—Ä–∞–Ω—å—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞',
          '–¢–≤–æ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ',
          '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—É',
          '–ö–æ–º–∞–Ω–¥—É–π —Å –≤—ã—Å–æ—Ç—ã'
        ];
        document.getElementById('map-title').textContent =
          `üß≠ GENESIS WAR MAP ‚Äî ${phrases[Math.floor(Math.random()*phrases.length)]}`;

        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
        map = L.map('map', {
          center: [49.25, -123.10],
          zoom: 6,
          minZoom: 3,
          maxZoom: 10,
          attributionControl: false,
          zoomControl: false
        });
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
        log('üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
        document.getElementById('map-status').textContent = 'Map: ‚úÖ Initialized';

        // –ë–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏
        const layers = {
          neutral: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
          world: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png'),
          satellite: L.tileLayer(
            'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            { attribution: 'Esri' }
          )
        };
        layers.neutral.addTo(map);
        
        document.getElementById('layer-select-small').onchange = e => {
          Object.values(layers).forEach(l => map.removeLayer(l));
          layers[e.target.value].addTo(map);
        };

        // –ì—Ä—É–ø–ø—ã —Å–ª–æ–µ–≤
        gridLayer = L.layerGroup().addTo(map);
        tileLayer = L.layerGroup().addTo(map);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
        await loadUserMarks();
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–π–ª–æ–≤
        log('üßÆ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∞–π–ª–æ–≤...');
        const refId = 22313, refLat = 49.25, refLng = -123.10;
        const refX = refId % 256, refY = Math.floor(refId/256);
        
        for (let tileId = 0; tileId < 65536; tileId++) {
          const x = tileId % 256;
          const y = Math.floor(tileId / 256);
          const lat = refLat - (y - refY) * degLat;
          const lng = refLng + (x - refX) * degLng;
          
          tileData.push({
            id_tile: tileId,
            lat: lat,
            lng: lng
          });
        }
        log(`‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${tileData.length} —Ç–∞–π–ª–æ–≤`);

        // –ü–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        renderFavorites();
        drawGrid();
        loadDynamicData();
        
      } catch (error) {
        log(`‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ initMap: ${error.message}`, true);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã');
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
    function saveMark(id, status) {
      saveUserMark(id, status === 'clear' ? 'clear' : status);
      updateTile(id);
    }

    function saveComment(id) {
      const comment = document.getElementById(`comment-${id}`)?.value.trim() || '';
      saveUserMark(id, 'comment', comment);
      updateTile(id);
    }

    function toggleFav(id) {
      const isFav = favs.includes(id);
      
      if (isFav) {
        favs = favs.filter(favId => favId !== id);
      } else {
        favs.push(id);
      }
      
      localStorage.setItem('favorites', JSON.stringify(favs));
      saveUserMark(id, isFav ? 'clear' : 'favorite');
      renderFavorites();
      updateTile(id);
    }

    function goToFav(id) {
      const t = tileData.find(o => o.id_tile === id);
      if (!t) return;
      map.flyTo([t.lat, t.lng], 6, { animate: true, duration: 1 });
      setTimeout(() => {
        drawGrid();
        drawTiles();
      }, 800);
    }

    function renderFavorites() {
      const favList = document.getElementById('favorites-list');
      if (!favList) return;
      
      favList.innerHTML = favs.map(id => {
        const tile = tileData.find(t => t.id_tile === id);
        return `
          <li data-id="${id}">
            –¢–∞–π–ª #${id} (${tile ? `${tile.lat.toFixed(4)}, ${tile.lng.toFixed(4)}` : ''})
            <button class="goto-fav" data-id="${id}">‚û°Ô∏è</button>
            <button class="remove-fav" data-id="${id}">√ó</button>
          </li>
        `;
      }).join('');
    }

    // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    function drawGrid() {
      gridLayer.clearLayers();
      const vb = map.getBounds();
      
      tileData.forEach(t => {
        if (!vb.contains([t.lat, t.lng])) return;
        
        const b = L.latLngBounds(
          [t.lat - degLat/2, t.lng - degLng/2],
          [t.lat + degLat/2, t.lng + degLng/2]
        );
        
        L.rectangle(b, {
          stroke: true,
          weight: 0.6,
          color: '#666',
          fill: false
        }).addTo(gridLayer);
      });
    }

    function createTileMarker(t) {
      const b = L.latLngBounds(
        [t.lat - degLat/2, t.lng - degLng/2],
        [t.lat + degLat/2, t.lng + degLng/2]
      );
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞
      const dynamicData = tileDynamicData[t.id_tile] || {};
      const userMark = userMarks[t.id_tile] || {};
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–µ—Ç–∫–∏
      const st = 
        userMark.ally ? 'ally' : 
        userMark.enemy ? 'enemy' : 
        userMark.favorite ? 'favorite' : '';
      
      const isFav = favs.includes(t.id_tile);
      const comment = userMark.comment || '';
      const owned = dynamicData.has_owner || false;
      
      // –°—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
      const fill = st === 'ally' ? '#33cc33'
                : st === 'enemy' ? '#cc3333'
                : st === 'favorite' ? '#ff0'
                : owned ? '#3366ff' : '#444';
                
      const stroke = st === 'ally' ? '#00ff00'
                  : st === 'enemy' ? '#ff0000'
                  : st === 'favorite' ? '#ff0' : '#000';

      const rect = L.rectangle(b, {
        stroke: true,
        weight: 1.2,
        color: stroke,
        dashArray: st ? '4' : null,
        fillColor: fill,
        fillOpacity: 0.4
      });

      // –î–æ–±–∞–≤–ª—è–µ–º tooltip
      const zoom = map.getZoom();
      if (zoom >= 5) {
        rect.bindTooltip(`#${t.id_tile}`, {
          permanent: true,
          direction: 'center',
          className: 'tile-label'
        });
      }

      // –°–æ–∑–¥–∞–µ–º popup
      const popupContent = document.createElement('div');
      popupContent.innerHTML = `
        <strong>–¢–∞–π–ª #${t.id_tile}</strong><br/>
        <div>–°—Ç–∞—Ç—É—Å: ${owned ? '–∑–∞–Ω—è—Ç' : '—Å–≤–æ–±–æ–¥–µ–Ω'}</div>
        ${dynamicData.owner ? `<div>–í–ª–∞–¥–µ–ª–µ—Ü: ${dynamicData.owner}</div>` : ''}
        ${dynamicData.resources ? `<div>–†–µ—Å—É—Ä—Å—ã: ${dynamicData.resources}</div>` : ''}
        <div>–ú–µ—Ç–∫–∞: ${st || '‚Äî'}</div>
        <div>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment || '‚Äî'}</div>
      `;
      
      const buttons = document.createElement('div');
      buttons.style.margin = '10px 0';
      buttons.style.display = 'flex';
      buttons.style.flexWrap = 'wrap';
      buttons.style.gap = '5px';
      
      // –ö–Ω–æ–ø–∫–∏ –º–µ—Ç–æ–∫
      ['ally', 'enemy', 'favorite', 'clear'].forEach(status => {
        const btn = document.createElement('button');
        btn.className = 'tile-popup-button';
        btn.dataset.status = status;
        btn.dataset.id = t.id_tile;
        btn.textContent = 
          status === 'ally' ? 'üü© –°–æ—é–∑–Ω–∏–∫' :
          status === 'enemy' ? 'üü• –í—Ä–∞–≥' :
          status === 'favorite' ? '‚≠êÔ∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : '‚ö™Ô∏è –°–±—Ä–æ—Å';
        buttons.appendChild(btn);
      });
      
      // –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      const favBtn = document.createElement('button');
      favBtn.className = 'tile-popup-button';
      favBtn.dataset.id = t.id_tile;
      favBtn.textContent = isFav ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
      buttons.appendChild(favBtn);
      
      // –ü–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
      const textarea = document.createElement('textarea');
      textarea.id = `comment-${t.id_tile}`;
      textarea.value = comment;
      textarea.placeholder = '–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...';
      textarea.style.width = '100%';
      textarea.style.minHeight = '60px';
      textarea.style.margin = '5px 0';
      textarea.style.padding = '5px';
      textarea.style.boxSizing = 'border-box';
      
      // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
      const saveBtn = document.createElement('button');
      saveBtn.className = 'tile-popup-button';
      saveBtn.dataset.id = t.id_tile;
      saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
      saveBtn.style.marginTop = '5px';
      
      popupContent.appendChild(buttons);
      popupContent.appendChild(textarea);
      popupContent.appendChild(saveBtn);
      
      rect.bindPopup(popupContent);
      rect.on('click', () => rect.openPopup());
      
      return rect;
    }

    function updateTile(id) {
      if (tileMarkers[id]) {
        tileLayer.removeLayer(tileMarkers[id]);
      }
      
      const tile = tileData.find(t => t.id_tile === id);
      if (!tile) return;
      
      const marker = createTileMarker(tile);
      tileMarkers[id] = marker;
      tileLayer.addLayer(marker);
    }

    function drawTiles() {
      const filter = document.getElementById('status-filter').value;
      const vb = map.getBounds();
      const searchValue = document.getElementById('search').value.trim();
      
      tileLayer.clearLayers();
      Object.values(tileMarkers).forEach(marker => tileLayer.removeLayer(marker));
      
      const filteredTiles = tileData.filter(t => {
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
        const userMark = userMarks[t.id_tile] || {};
        const st = 
          userMark.ally ? 'ally' : 
          userMark.enemy ? 'enemy' : 
          userMark.favorite ? 'favorite' : '';
        
        if (filter === 'ally' && !userMark.ally) return false;
        if (filter === 'enemy' && !userMark.enemy) return false;
        if (filter === 'favorite' && !userMark.favorite) return false;
        if (filter === 'clear' && st) return false;
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫—É
        if (searchValue && String(t.id_tile) !== searchValue) return false;
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
        return vb.contains([t.lat, t.lng]);
      });
      
      filteredTiles.forEach(t => {
        const marker = createTileMarker(t);
        tileMarkers[t.id_tile] = marker;
        tileLayer.addLayer(marker);
      });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      // –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
      document.getElementById('search-clear').addEventListener('click', () => {
        document.getElementById('search').value = '';
        drawTiles();
      });

      // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–∞–π–ª—É
      document.getElementById('goto-btn').addEventListener('click', () => {
        const v = document.getElementById('search').value.trim();
        if (!v) return drawTiles();
        
        const t = tileData.find(o => +o.id_tile === +v);
        if (!t) return;
        
        map.flyTo([t.lat, t.lng], 6, { animate: true, duration: 1 });
        setTimeout(() => {
          drawGrid();
          drawTiles();
        }, 800);
      });

      // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
      document.getElementById('search').addEventListener('input', () => drawTiles());
      
      // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
      document.getElementById('reset').addEventListener('click', () => {
        document.getElementById('search').value = '';
        document.getElementById('status-filter').value = '';
        drawGrid();
        drawTiles();
      });
      
      // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
      document.getElementById('status-filter').addEventListener('change', () => {
        drawGrid();
        drawTiles();
      });
      
      // –°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞
      document.getElementById('screenshot-btn').addEventListener('click', () => {
        html2canvas(document.getElementById('map')).then(canvas => {
          const link = document.createElement('a');
          link.href = canvas.toDataURL('image/png');
          link.download = `map-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
          link.click();
        }).catch(e => {
          log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: ${e.message}`, true);
        });
      });
      
      // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
      document.getElementById('toggle-panel').addEventListener('click', function() {
        const panel = document.getElementById('panel');
        panel.classList.toggle('collapsed');
        this.textContent = panel.classList.contains('collapsed') ? 'üîº' : 'üîΩ';
      });
      
      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ø–∞–ø–æ–≤
      map.on('popupopen', (e) => {
        const popup = e.popup;
        const content = popup.getElement();
        
        content.addEventListener('click', (e) => {
          const target = e.target;
          if (!target.classList.contains('tile-popup-button')) return;
          
          const tileId = parseInt(target.dataset.id);
          
          if (target.dataset.status) {
            saveMark(tileId, target.dataset.status);
          } else if (target.textContent.includes('–∏–∑–±—Ä–∞–Ω–Ω')) {
            toggleFav(tileId);
          } else if (target.textContent.includes('–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π')) {
            saveComment(tileId);
          }
          
          popup.setContent(createTileMarker(
            tileData.find(t => t.id_tile === tileId)
          ).getPopup().getContent());
        });
      });
      
      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      document.getElementById('favorites-list').addEventListener('click', (e) => {
        if (!e.target.matches('button')) return;
        
        const tileId = parseInt(e.target.dataset.id);
        if (e.target.classList.contains('goto-fav')) {
          goToFav(tileId);
        } else if (e.target.classList.contains('remove-fav')) {
          toggleFav(tileId);
        }
      });
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', async () => {
      initSupabase();
      let favs = JSON.parse(localStorage.getItem('favorites') || '[]');
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      const dbg = (id, msg) => {
        const e = document.getElementById(id);
        if (e) e.textContent = `${e.textContent.split(':')[0]}: ${msg}`;
      };
      
      try {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram
        const tg = window.Telegram?.WebApp;
        dbg('tg-status', tg ? '‚úÖ Loaded' : '‚ùå Not available');
        
        if (tg) {
          tg.ready();
          log('ü§ñ Telegram WebApp ready');
        }
        
        const tgUser = tg?.initDataUnsafe?.user || null;
        dbg('user-status', tgUser ? `‚úÖ ${tgUser.first_name}` : '‚ùå No user');
        
        if (tgUser) {
          await syncUser(tgUser);
          window.__tgUser = tgUser;
        } else {
          log('üë§ TG user: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (offline)');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.body.classList.add('logged-in');
        await initMap(tgUser || { 
          id: 'test-user', 
          first_name: 'Test User',
          username: 'test'
        });
        
        setupEventListeners();
        dbg('map-status', '‚úÖ Initialized');
        log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        setInterval(loadDynamicData, CACHE_TTL);
      } catch (error) {
        dbg('error-log', `‚ùå ${error.message}`);
        log(`‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, true);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
      }
    });
  </script>
</body>
</html>
