<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Genesis Map ‚Äî –¢–∞–π–ª—ã –∏ —Ä–µ—Å—É—Ä—Å—ã</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { position: absolute; top: 50px; left: 0; right: 0; bottom: 0; }
    #panel {
      position: absolute; top: 0; left: 0; right: 0;
      height: 50px; background: #222; color: white;
      display: flex; align-items: center; padding: 0 10px;
      font-family: sans-serif; font-size: 14px;
      gap: 10px;
    }
    #panel input, #panel select {
      font-size: 14px;
      padding: 4px;
    }
    .tile-label {
      font-size: 10px;
      color: rgba(255,255,255,0.8);
      text-shadow: 0 0 2px black;
    }
  </style>
</head>
<body>
  <div id="panel">
    <label>üîç –¢–∞–π–ª ID: <input type="number" id="search" placeholder="12345" /></label>
    <label>‚öôÔ∏è –§–∏–ª—å—Ç—Ä: 
      <select id="filter">
        <option value="">‚Äî –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äî</option>
        <option value="iron">–ñ–µ–ª–µ–∑–æ</option>
        <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
        <option value="platinum">–ü–ª–∞—Ç–∏–Ω–∞</option>
        <option value="silver">–°–µ—Ä–µ–±—Ä–æ</option>
        <option value="copper">–ú–µ–¥—å</option>
        <option value="tungsten">–í–æ–ª—å—Ñ—Ä–∞–º</option>
        <option value="uranium">–£—Ä–∞–Ω</option>
        <option value="rare_earth_elements">–†–µ–¥–∫. —ç–ª–µ–º–µ–Ω—Ç—ã</option>
      </select>
    </label>
    <span id="count">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–∞–π–ª—ã‚Ä¶</span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
  (async function(){
    const map = L.map('map', {
      center: [0, 0],
      zoom: 2,
      minZoom: 0,
      maxZoom: 8
    });

    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Map ¬© Esri' }
    ).addTo(map);

    const gridLayer = L.layerGroup().addTo(map);
    const tileLayer = L.layerGroup().addTo(map);

    const PARTS = Array.from({ length: 22 }, (_, i) =>
      `./data/tiles_${String(i+1).padStart(2,'0')}.json`
    );

    let tileData = [];
    try {
      const chunks = await Promise.all(
        PARTS.map(url => fetch(url).then(r => r.json()))
      );
      tileData = chunks.flat();
      document.getElementById("count").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∞–π–ª–æ–≤: ${tileData.length}`;
    } catch(err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:', err);
      return;
    }

    tileData.forEach(t => {
      const id = parseInt(t.id_tile, 10);
      const idx = id - 1;
      t.x = idx % 256;
      t.y = Math.floor(idx / 256);
    });

    function drawGrid() {
      gridLayer.clearLayers();
      const z = map.getZoom(), s = 256;
      const b = map.getBounds();
      const nw = map.project(b.getNorthWest(), z);
      const se = map.project(b.getSouthEast(), z);
      const x0 = Math.floor(nw.x / s), x1 = Math.floor(se.x / s);
      const y0 = Math.floor(nw.y / s), y1 = Math.floor(se.y / s);

      for (let y = y0; y <= y1; y++) {
        for (let x = x0; x <= x1; x++) {
          const p0 = L.point(x*s, y*s);
          const p1 = L.point((x+1)*s, (y+1)*s);
          const rect = L.latLngBounds(
            map.unproject(p0, z), map.unproject(p1, z)
          );
          L.rectangle(rect, {
            weight: 1,
            color: 'rgba(255,255,255,0.2)',
            interactive: false
          }).addTo(gridLayer);
          L.marker(rect.getCenter(), {
            icon: L.divIcon({
              className: 'tile-label',
              html: `${y}-${x}`,
              iconSize: [0, 0]
            }),
            interactive: false
          }).addTo(gridLayer);
        }
      }
    }

    function drawTiles() {
      tileLayer.clearLayers();
      const z = map.getZoom(), s = 256;
      const b = map.getBounds();
      const nw = map.project(b.getNorthWest(), z);
      const se = map.project(b.getSouthEast(), z);
      const x0 = Math.floor(nw.x / s), x1 = Math.floor(se.x / s);
      const y0 = Math.floor(nw.y / s), y1 = Math.floor(se.y / s);

      const resourceFilter = document.getElementById('filter').value;
      const searchID = parseInt(document.getElementById('search').value);

      tileData.forEach(t => {
        if (t.x < x0 || t.x > x1 || t.y < y0 || t.y > y1) return;

        if (resourceFilter && parseInt(t[resourceFilter]) === 0) return;
        if (!isNaN(searchID) && parseInt(t.id_tile) !== searchID) return;

        const p0 = L.point(t.x*s, t.y*s);
        const p1 = L.point((t.x+1)*s, (t.y+1)*s);
        const bounds = L.latLngBounds(
          map.unproject(p0, z), map.unproject(p1, z)
        );
        const owned = String(t.has_owner).toLowerCase() === "true";

        const resources = [
          'iron','gold','platinum','copper','silver','limestone',
          'aluminum','titanium','tungsten','uranium','rare_earth_elements'
        ].filter(res => parseInt(t[res]) > 0)
          .map(res => `‚Ä¢ ${res}: ${t[res]}`)
          .join('<br>');

        L.rectangle(bounds, {
          weight: 0,
          fillOpacity: 0.4,
          fillColor: owned ? '#ff4444' : '#444444'
        })
        .bindPopup(`
          <strong>–¢–∞–π–ª #${t.id_tile}</strong><br>
          –í–ª–∞–¥–µ–ª–µ—Ü: ${owned ? '‚úÖ' : '‚Äî'}<br>
          ${resources || '–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤'}
        `)
        .addTo(tileLayer);
      });
    }

    drawGrid();
    drawTiles();
    map.on('zoomend moveend', drawGrid);
    map.on('zoomend moveend', drawTiles);

    document.getElementById('filter').addEventListener('change', drawTiles);
    document.getElementById('search').addEventListener('input', drawTiles);
  })();
  </script>
</body>
</html>
