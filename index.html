<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>DEBUG: GENESIS TILE TEST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .tile-label {
      font-size: 9px;
      color: black;
      background: yellow;
      padding: 2px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
  (async function(){
    const map = L.map('map', {
      center: [0, 0],
      zoom: 2,
      minZoom: 1,
      maxZoom: 8
    });

    // Используем OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const tileLayer = L.layerGroup().addTo(map);

    // Загружаем JSON-файлы
    const PARTS = Array.from({ length: 22 }, (_, i) =>
      `./data/tiles_${String(i+1).padStart(2,'0')}.json`
    );

    let tileData = [];
    try {
      const chunks = await Promise.all(
        PARTS.map(url => fetch(url).then(r => r.json()))
      );
      tileData = chunks.flat();
      console.log('Загружено тайлов:', tileData.length);
    } catch(err) {
      console.error('Ошибка загрузки JSON:', err);
      return;
    }

    tileData.forEach((t, idx) => {
      const id = parseInt(t.id_tile, 10);
      const i = id - 1;
      t.x = i % 256;
      t.y = Math.floor(i / 256);
      if (idx < 5) console.log(`Тайл #${id} → x:${t.x}, y:${t.y}`);
    });

    function drawTiles() {
      const s = 256;
      const z = map.getZoom();
      tileLayer.clearLayers();

      tileData.forEach(t => {
        const p0 = L.point(t.x*s, t.y*s);
        const p1 = L.point((t.x+1)*s, (t.y+1)*s);
        const bounds = L.latLngBounds(
          map.unproject(p0, z), map.unproject(p1, z)
        );

        L.rectangle(bounds, {
          weight: 1,
          color: '#000',
          fillColor: '#ffff66',
          fillOpacity: 0.5
        })
        .bindPopup(`Тайл #${t.id_tile}<br>x: ${t.x} / y: ${t.y}`)
        .addTo(tileLayer);

        L.marker(bounds.getCenter(), {
          icon: L.divIcon({
            className: 'tile-label',
            html: `${t.id_tile}`,
            iconSize: [30,10]
          })
        }).addTo(tileLayer);
      });
    }

    drawTiles();
    map.on('zoomend moveend', drawTiles);
  })();
  </script>
</body>
</html>
